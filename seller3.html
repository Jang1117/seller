<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Seller Dashboard Pro</title>

  <!-- SheetJS / Tailwind / html2canvas(í”„ë¦°íŠ¸ ìº¡ì²˜) -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;900&display=swap');
    body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }

    /* í™œì„±í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .active-view-btn { background-color: #2563eb !important; color: white !important; }
    .active-filter-btn { background-color: #2563eb !important; color: white !important; }
    .active-tab { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 900; }

    /* ì• ë‹ˆë©”ì´ì…˜ */
    .card-animate { animation: fadeInUp 0.3s ease-out forwards; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
    .custom-scrollbar::-webkit-scrollbar { width: 5px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }

    /* ë¡œê·¸ ì„ íƒ ê°•ì¡°(í† ê¸€) */
    .selected-log-item {
      border: 2px solid #2563eb !important;
      background-color: #eff6ff !important;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    /* ë¹ˆ ìƒíƒœ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .empty-state-card {
      border: 2px dashed #cbd5e1;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    .empty-state-card:hover {
      border-color: #2563eb;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }

    /* =========================
      ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ (í•œ í˜ì´ì§€ì— ìµœëŒ€í•œ ë³´ì´ë„ë¡ ì¡°ì •)
    ========================= */

    /* ìº˜ë¦°ë” ì „ì²´ ì˜ì—­ì´ í™”ë©´ ë†’ì´ì— ë§ê²Œ ë“¤ì–´ì˜¤ë„ë¡ */
    #calendarView .calendar-shell {
      /* header/footer ë†’ì´ëŠ” ëŒ€ëµì , ì—¬ê¸°ì„œëŠ” main paddingê¹Œì§€ ê³ ë ¤í•´ì„œ ì—¬ìœ  */
      min-height: calc(100vh - 150px);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .calendar-day {
      /* âœ… í™”ë©´ì— ë” ë§ì´ ë³´ì´ê²Œ: ì•½ê°„ ë‚©ì‘í•˜ê²Œ */
      aspect-ratio: 1 / 0.82;
      background: white;
      border-radius: 12px;
      padding: 2px 4px;
      transition: all 0.2s;
      border: 1px solid #e2e8f0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .calendar-day:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 5;
    }
    .calendar-day.today {
      border: 2px solid #2563eb;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .calendar-day.other-month {
      background: #f8fafc;
      opacity: 0.5;
    }
    .calendar-day.has-events {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border-color: #86efac;
    }

    /* âœ… ìˆ˜ì •: ë‚ ì§œ ìˆ«ì ì˜ì—­ ê³ ì • - ì´ë²¤íŠ¸ì™€ ë¶„ë¦¬ */
    .calendar-day-num {
      font-size: clamp(10px, 1.2vw, 13px);
      line-height: 1;
      margin-bottom: 4px;         /* âœ… ë‚ ì§œì™€ ì´ë²¤íŠ¸ ê°„ê²© ì¦ê°€ */
      padding-bottom: 2px;        /* âœ… ì¶”ê°€ ê°„ê²© */
      flex-shrink: 0;
      height: auto;
      display: block;
    }

    .calendar-events-container {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 2px;                   /* âœ… gap ì•½ê°„ ì¦ê°€ */
      min-height: 0;
      padding-top: 2px;           /* âœ… ë‚ ì§œì™€ ê°„ê²© ì¶”ê°€ */
    }

    /* âœ… í•µì‹¬ ìˆ˜ì •: ì´ë²¤íŠ¸ í…ìŠ¤íŠ¸ ìˆ˜ì§ ì •ë ¬ ì™„ë²½ ìˆ˜ì • */
    .calendar-event {
      font-size: clamp(9px, 0.95vw, 11px);
      padding: 0 6px;
      border-radius: 3px;
      cursor: grab;
      transition: all 0.15s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-shrink: 0;
      
      /* âœ… flex + í•œê¸€ í°íŠ¸ ë³´ì • */
      display: flex;
      align-items: center;
      justify-content: flex-start;
      min-height: 16px;
      height: 16px;
      box-sizing: border-box;
      padding-bottom: 2px;        /* âœ… í•œê¸€ baseline ë³´ì • - í…ìŠ¤íŠ¸ ìœ„ë¡œ */
    }
    .calendar-event:active { cursor: grabbing; }
    .calendar-event:hover {
      transform: scale(1.01);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .calendar-more-btn {
      font-size: clamp(9px, 1vw, 12px);
      color: #64748b;
      font-weight: 700;
      cursor: pointer;
      padding: 0 4px;
      padding-bottom: 2px;        /* âœ… í•œê¸€ baseline ë³´ì • */
      border-radius: 3px;
      background: #f1f5f9;
      text-align: center;
      flex-shrink: 0;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .calendar-more-btn:hover {
      background: #e2e8f0;
      color: #2563eb;
    }

    /* âœ… í”„ë¦°íŠ¸ ìº¡ì²˜ìš© ìŠ¤íƒ€ì¼ (html2canvasìš©) */
    .print-capture-mode .calendar-event {
      padding-bottom: 10px !important;  /* âœ… ìº¡ì²˜ ì‹œ í•œê¸€ ë³´ì • */
    }
    .print-capture-mode .calendar-more-btn {
      padding-bottom: 10px !important;  /* âœ… ìº¡ì²˜ ì‹œ í•œê¸€ ë³´ì • */
    }

    .calendar-header-day {
      text-align: center;
      font-weight: 900;
      font-size: 11px;
      text-transform: uppercase;
      padding: 8px 0; /* âœ… í—¤ë” ì¤„ì„ */
      color: #64748b;
    }
    .calendar-header-day.sun { color: #ef4444; }
    .calendar-header-day.sat { color: #3b82f6; }

    .event-color-0 { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; }
    .event-color-1 { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: #166534; }
    .event-color-2 { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; }
    .event-color-3 { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); color: #9d174d; }
    .event-color-4 { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); color: #3730a3; }
    .event-color-5 { background: linear-gradient(135deg, #ccfbf1 0%, #99f6e4 100%); color: #115e59; }

    /* ì´ë²¤íŠ¸ ìƒì„¸ íŒì—… */
    .event-tooltip {
      position: absolute;
      z-index: 100;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 16px;
      min-width: 280px;
      max-width: 350px;
      animation: tooltipIn 0.2s ease-out;
    }
    @keyframes tooltipIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== í”„ë¦°íŠ¸ìš© ì»¨í…Œì´ë„ˆ (ìº¡ì²˜ ì´ë¯¸ì§€ ì¶œë ¥) ===== */
    #calendarPrintContainer { display: none; }

    /* ===== ë¡œë”© ì˜¤ë²„ë ˆì´ ===== */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 900;
    }
    #loadingOverlay.active { display: flex; }

    /* ===== ì¸ì‡„ CSS - í•µì‹¬ ìˆ˜ì • ===== */
    @media print {
      html, body { height: 100%; margin: 0 !important; }
      body * { visibility: hidden !important; }

      #calendarPrintContainer, #calendarPrintContainer * {
        visibility: visible !important;
      }

      /* âœ… í˜ì´ì§€ ì¤‘ì•™ ì •ë ¬ */
      #calendarPrintContainer {
        display: flex !important;
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        background: white;

        align-items: center;      /* ì„¸ë¡œ ì¤‘ì•™ */
        justify-content: center;  /* ê°€ë¡œ ì¤‘ì•™ */
      }

      /* âœ… ì´ë¯¸ì§€ contain + ì¤‘ì•™ */
      #calendarPrintContainer img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
        display: block;
      }

      /* âœ… í”„ë¦°íŠ¸ ì „ìš© ìŠ¤íƒ€ì¼ - í…ìŠ¤íŠ¸ ì •ë ¬ ê³ ì • */
      .calendar-day-num {
        font-size: 11px !important;
        height: auto !important;
        line-height: 1 !important;
        margin-bottom: 4px !important;
        padding-bottom: 2px !important;
      }
      
      .calendar-event { 
        font-size: 10px !important; 
        min-height: 16px !important; 
        height: 16px !important;
        padding: 0 6px !important;
        padding-bottom: 5px !important;  /* âœ… í”„ë¦°íŠ¸ìš©: ë” í¬ê²Œ */
        display: flex !important;
        align-items: center !important;
      }
      
      .calendar-more-btn {
        padding-bottom: 5px !important;  /* âœ… í”„ë¦°íŠ¸ìš©: ë” í¬ê²Œ */
      }
    }
  </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

  <!-- í—¤ë” -->
  <header class="bg-white border-b shadow-sm z-30 px-6 py-3 flex flex-col lg:flex-row items-center justify-between gap-3">
    <div class="flex items-center gap-3 flex-wrap">
      <div class="flex items-center mr-2">
        <img src="logo.jpg" alt="Seller Dashboard Logo" class="h-7 md:h-8 w-auto object-contain" />
      </div>

      <!-- ê¸°ê°„ í•„í„° -->
      <div class="flex bg-white p-1 rounded-xl border border-slate-200 shadow-sm items-center gap-1">
        <button onclick="navigatePeriod(-1)" class="p-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-all" title="ì´ì „">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>

        <button id="viewAllBtn" onclick="resetGlobalFilter()" class="px-3 py-2 text-xs font-bold rounded-lg text-slate-500 hover:bg-slate-50 transition-all">ì „ì²´</button>
        <div class="w-px h-4 bg-slate-200"></div>

        <select id="filterYear" class="px-2 py-2 text-xs font-bold rounded-lg text-slate-500 bg-slate-50 border border-slate-200 outline-none">
          <option value="">ì—°ë„</option>
          <option value="2026" selected>2026</option>
          <option value="2027">2027</option>
          <option value="2028">2028</option>
        </select>

        <select id="filterMonth" class="px-2 py-2 text-xs font-bold rounded-lg text-slate-500 bg-slate-50 border border-slate-200 outline-none">
          <option value="">ì›”</option>
          <option value="01" selected>01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option>
          <option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option>
          <option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
        </select>

        <button onclick="navigatePeriod(1)" class="p-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-all" title="ë‹¤ìŒ">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>

      <!-- ë·° ì „í™˜ -->
      <div class="flex bg-white p-1 rounded-xl border border-slate-200 shadow-sm items-center gap-1">
        <button id="viewSellerBtn" onclick="switchView('seller')" class="px-4 py-2 text-xs font-bold rounded-lg active-view-btn">ğŸ‘¤ ì…€ëŸ¬</button>
        <button id="viewProductBtn" onclick="switchView('product')" class="px-4 py-2 text-xs font-bold rounded-lg text-slate-500 hover:bg-slate-50 transition-all">ğŸ“¦ ìƒí’ˆ</button>
        <button id="viewCalendarBtn" onclick="switchView('calendar')" class="px-4 py-2 text-xs font-bold rounded-lg text-slate-500 hover:bg-slate-50 transition-all">ğŸ“… ìº˜ë¦°ë”</button>
        <button id="viewStatsBtn" onclick="switchView('stats')" class="px-4 py-2 text-xs font-bold rounded-lg text-slate-500 hover:bg-slate-50 transition-all">ğŸ“Š ìš”ì•½</button>
      </div>

      <!-- ì…€ëŸ¬ í•„í„° -->
      <div id="sellerFilterGroup" class="flex bg-slate-100 p-1 rounded-xl border border-slate-200 shadow-sm">
        <button onclick="setSellerFilter('all')" id="filterAll" class="px-3 py-2 text-[11px] font-bold rounded-lg active-filter-btn text-white">ì „ì²´</button>
        <button onclick="setSellerFilter('hasProduct')" id="filterHas" class="px-3 py-2 text-[11px] font-bold rounded-lg text-slate-500">ìƒí’ˆ ìˆìŒ</button>
        <button onclick="setSellerFilter('noProduct')" id="filterNo" class="px-3 py-2 text-[11px] font-bold rounded-lg text-slate-500">ìƒí’ˆ ì—†ìŒ</button>
      </div>

      <!-- ì‹ ê·œ ì¶”ê°€ -->
      <button onclick="openNewEntryModal()" class="flex items-center gap-1.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:from-blue-700 hover:to-indigo-700 transition-all shadow-md hover:shadow-lg">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        ì‹ ê·œ ì¶”ê°€
      </button>
    </div>

    <!-- ê²€ìƒ‰/ë°ì´í„° ê´€ë¦¬ -->
    <div class="flex items-center gap-2">
      <div id="searchArea" class="relative w-40">
        <input type="text" id="globalSearch" oninput="renderAll()" placeholder="ê²€ìƒ‰."
               class="w-full pl-8 pr-4 py-2 bg-slate-50 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500">
        <svg class="w-3.5 h-3.5 text-slate-400 absolute left-2.5 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>

      <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-3 py-2 rounded-xl text-[11px] font-bold hover:bg-emerald-700 transition-all">ì €ì¥</button>
      <button onclick="triggerImport()" class="bg-slate-700 text-white px-3 py-2 rounded-xl text-[11px] font-bold hover:bg-slate-800 transition-all">ë¶ˆëŸ¬ì˜¤ê¸°</button>

      <!-- âœ… ìº˜ë¦°ë” í”„ë¦°íŠ¸ ë²„íŠ¼ -->
      <button onclick="openCalendarPrintModal()" class="bg-blue-600 text-white px-3 py-2 rounded-xl text-[11px] font-bold hover:bg-blue-700 transition-all">
        ìº˜ë¦°ë” í”„ë¦°íŠ¸
      </button>
      <!-- âœ… ë„ì›€ë§ ë²„íŠ¼ (ì¶”ê°€) -->
      <button onclick="openHelpPopup()" class="bg-slate-100 text-slate-700 border border-slate-200 px-3 py-2 rounded-xl text-[11px] font-bold hover:bg-slate-200 transition-all">
        ë„ì›€ë§
      </button>
      <button onclick="clearAllData()" class="bg-red-50 text-red-600 border border-red-100 px-3 py-2 rounded-xl text-[11px] font-bold hover:bg-red-100">ì´ˆê¸°í™”</button>
      <input type="file" id="importFile" class="hidden" accept=".xlsx, .xls, .csv" onchange="importData(event)">
    </div>
  </header>

  <!-- ë©”ì¸ -->
  <main id="mainArea" class="flex-1 overflow-y-auto p-5 custom-scrollbar">
    <div class="max-w-[1500px] mx-auto">
      <!-- ê·¸ë¦¬ë“œ ë·° -->
      <div id="mainGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-5"></div>

      <!-- ìº˜ë¦°ë” ë·° -->
      <div id="calendarView" class="hidden space-y-3 animate-in fade-in duration-500 calendar-shell">
        <div class="bg-white p-4 rounded-[2rem] shadow-sm border border-slate-100">
          <!-- ë²”ë¡€ -->
          <div class="flex items-center justify-end gap-4 mb-3">
            <div class="flex items-center gap-2 text-xs">
              <span class="w-3 h-3 rounded-full bg-gradient-to-r from-green-200 to-green-300"></span>
              <span class="text-slate-500 font-medium">ì¼ì • ìˆìŒ</span>
            </div>
            <div class="flex items-center gap-2 text-xs">
              <span class="w-3 h-3 rounded-full bg-blue-500"></span>
              <span class="text-slate-500 font-medium">ì˜¤ëŠ˜</span>
            </div>
          </div>

          <!-- ìš”ì¼ í—¤ë” -->
          <div class="calendar-grid mb-2">
            <div class="calendar-header-day sun">ì¼</div>
            <div class="calendar-header-day">ì›”</div>
            <div class="calendar-header-day">í™”</div>
            <div class="calendar-header-day">ìˆ˜</div>
            <div class="calendar-header-day">ëª©</div>
            <div class="calendar-header-day">ê¸ˆ</div>
            <div class="calendar-header-day sat">í† </div>
          </div>

          <!-- ë‚ ì§œ ê·¸ë¦¬ë“œ -->
          <div id="calendarGrid" class="calendar-grid"></div>
        </div>

        <!-- ì„ íƒëœ ë‚ ì§œ ì¼ì • -->
        <div id="selectedDateEvents" class="hidden bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100">
          <div class="flex justify-between items-center mb-4">
            <h3 id="selectedDateTitle" class="text-lg font-black text-slate-800"></h3>
            <button onclick="closeSelectedDateEvents()" class="text-slate-400 hover:text-slate-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <div id="selectedDateEventsList" class="space-y-3"></div>
        </div>
      </div>

      <!-- í†µê³„ ë·° -->
      <div id="statsView" class="hidden space-y-8 animate-in fade-in duration-500">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
          <div>
            <h2 class="text-2xl font-black text-slate-800 tracking-tight">ì›”ë³„ ë§¤ì¶œ ìš”ì•½ ë¦¬í¬íŠ¸</h2>
            <p id="statsDisplayTitle" class="text-blue-600 font-bold uppercase text-sm mt-1"></p>
          </div>

          <div class="flex bg-slate-100 p-1 rounded-xl border border-slate-200 shadow-sm">
            <button id="statsModeSeller" onclick="setStatsMode('seller')" class="px-3 py-2 text-[11px] font-bold rounded-lg active-filter-btn text-white">ì…€ëŸ¬ ê¸°ì¤€</button>
            <button id="statsModeProduct" onclick="setStatsMode('product')" class="px-3 py-2 text-[11px] font-bold rounded-lg text-slate-500">ìƒí’ˆ ê¸°ì¤€</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div class="md:col-span-1 bg-blue-600 p-8 rounded-[2.5rem] shadow-xl text-white flex flex-col justify-center">
            <p class="text-blue-100 text-xs font-black uppercase mb-2">Total Revenue</p>
            <h3 id="totalMonthRevenue" class="text-5xl font-black">0.00 <span class="text-xl font-bold">ì–µì›</span></h3>
          </div>
          <div class="md:col-span-2 bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 pr-2">
            <div id="statsTableContainer" class="space-y-4 max-h-[500px] overflow-y-auto custom-scrollbar"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- í‘¸í„° -->
  <footer class="bg-white border-t py-3 px-8 text-center md:flex md:justify-between items-center z-30">
    <p class="text-slate-400 text-xs font-medium">Â© 2026 <span class="font-black text-slate-600 uppercase">Mr. Oasis</span>. All rights reserved. |
      <a href="mailto:7911171g@gmail.com" style="color: black; font-weight: 600;">âœ‰ï¸ 7911171g@gmail.com</a>
    </p>
    <p class="text-slate-400 text-xs font-medium mt-1 md:mt-0">Seller Management System</p>
  </footer>

  <!-- ===== í”„ë¦°íŠ¸ ì»¨í…Œì´ë„ˆ / ì˜¤ë²„ë ˆì´ ===== -->
  <div id="calendarPrintContainer"></div>
  <div id="loadingOverlay">
    <div class="bg-slate-900/50 border border-white/10 px-6 py-4 rounded-2xl shadow-xl">
      <div class="text-lg font-black mb-1">ì¸ì‡„ ì¤€ë¹„ ì¤‘...</div>
      <div class="text-sm text-white/80 font-bold">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
    </div>
  </div>

  <!-- ===== ìº˜ë¦°ë” í”„ë¦°íŠ¸ ëª¨ë‹¬ ===== -->
  <div id="calendarPrintModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
    <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md overflow-hidden">
      <div class="p-6 border-b bg-slate-50">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-black text-slate-800">ìº˜ë¦°ë” í”„ë¦°íŠ¸</h3>
          <button onclick="closeCalendarPrintModal()" class="text-slate-400 hover:text-slate-600 font-bold text-2xl">Ã—</button>
        </div>
        <p class="text-xs font-bold text-slate-400 mt-2">A4 ìš©ì§€ ë°©í–¥ì„ ì„ íƒí•˜ì„¸ìš”</p>
      </div>
      <div class="p-6 space-y-4">
        <div class="flex gap-2">
          <button id="printOriPortrait" onclick="setCalendarPrintOrientation('portrait')"
                  class="flex-1 py-3 rounded-xl border-2 border-blue-600 bg-blue-50 text-blue-700 font-black text-sm">
            ì„¸ë¡œ(ê¸°ë³¸)
          </button>
          <button id="printOriLandscape" onclick="setCalendarPrintOrientation('landscape')"
                  class="flex-1 py-3 rounded-xl border-2 border-slate-200 text-slate-600 font-black text-sm hover:bg-slate-50">
            ê°€ë¡œ
          </button>
        </div>

        <div class="bg-slate-50 border border-slate-100 rounded-xl p-4 text-[11px] text-slate-500 font-bold leading-relaxed">
          âœ… ì¸ì‡„ ì „ ìº˜ë¦°ë” ë ˆì´ì•„ì›ƒì„ ê¸°ì¤€ìœ¼ë¡œ í–‰ì‚¬ í‘œì‹œ ê°œìˆ˜ë¥¼ ì¬ê³„ì‚°í•©ë‹ˆë‹¤.<br/>
          âœ… ì¸ì‡„ ì´ë¯¸ì§€ëŠ” ìš©ì§€ ì¤‘ì•™ì— ë§ì¶° ì¶œë ¥ë©ë‹ˆë‹¤.
        </div>

        <button onclick="executeCalendarPrint()" class="w-full py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-black">
          í”„ë¦°íŠ¸ ì‹¤í–‰
        </button>
      </div>
    </div>
  </div>

  
  <!-- ===== ì‹ ê·œ ì…ë ¥ ëª¨ë‹¬ / ì…€ëŸ¬ ëª¨ë‹¬ / ìƒí’ˆ ëª¨ë‹¬ (ì›ë³¸ ê·¸ëŒ€ë¡œ) ===== -->
  <!-- (ê¸¸ì´ ë•Œë¬¸ì— UI ë¶€ë¶„ì€ ì›ë³¸ êµ¬ì¡° ìœ ì§€: ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë™ì¼í•˜ê²Œ ë™ì‘) -->

  <!-- ì‹ ê·œ ë°ì´í„° ì…ë ¥ ëª¨ë‹¬ -->
  <div id="newEntryModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
    <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in duration-150">
      <div class="p-8 border-b bg-gradient-to-r from-blue-600 to-indigo-600 relative">
        <h2 class="text-2xl font-black text-white tracking-tight">ì‹ ê·œ ë°ì´í„° ì¶”ê°€</h2>
        <p class="text-blue-100 text-sm mt-1">ì…€ëŸ¬ì™€ ìƒí’ˆ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
        <button onclick="closeNewEntryModal()" class="absolute top-8 right-8 text-white/70 hover:text-white font-bold text-2xl transition-colors">Ã—</button>
      </div>
      <div class="p-8 space-y-5">
        <div class="flex flex-col gap-2">
          <label class="text-[11px] font-black text-slate-500 uppercase tracking-wider flex items-center gap-1">
            ì…€ëŸ¬ëª… <span class="text-red-500">*</span>
            <span class="text-slate-400 font-normal normal-case">(í•„ìˆ˜)</span>
          </label>
          <div class="relative">
            <input type="text" id="newSellerName" list="existingSellersList"
                   class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all"
                   placeholder="ì…€ëŸ¬ëª… ì…ë ¥ ë˜ëŠ” ì„ íƒ">
            <datalist id="existingSellersList"></datalist>
          </div>
        </div>

        <div class="flex flex-col gap-2">
          <label class="text-[11px] font-black text-slate-500 uppercase tracking-wider flex items-center gap-1">
            ìƒí’ˆëª… <span class="text-slate-400 font-normal normal-case">(ì„ íƒ)</span>
          </label>
          <div class="relative">
            <input type="text" id="newProductName" list="existingProductsList"
                   class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all"
                   placeholder="ìƒí’ˆëª… ì…ë ¥ ë˜ëŠ” ì„ íƒ">
            <datalist id="existingProductsList"></datalist>
          </div>
        </div>

        <div class="flex flex-col gap-2">
          <label class="text-[11px] font-black text-slate-500 uppercase tracking-wider flex items-center gap-1">
            í–‰ì‚¬ì¼ <span class="text-slate-400 font-normal normal-case">(ì„ íƒ)</span>
          </label>
          <input type="date" id="newEventDate"
                 class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all">
        </div>

        <div class="flex flex-col gap-2">
          <label class="text-[11px] font-black text-slate-500 uppercase tracking-wider flex items-center gap-1">
            ë§¤ì¶œì•¡ <span class="text-slate-400 font-normal normal-case">(ì„ íƒ, ì–µì› ë‹¨ìœ„)</span>
          </label>
          <input type="number" id="newRevenue" step="0.01" min="0"
                 class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all"
                 placeholder="0.00">
        </div>

        <div class="flex gap-3 pt-4">
          <button onclick="closeNewEntryModal()" class="flex-1 py-3 px-4 border-2 border-slate-200 text-slate-600 rounded-xl text-sm font-bold hover:bg-slate-50 transition-all">
            ì·¨ì†Œ
          </button>
          <button onclick="submitNewEntry()" class="flex-1 py-3 px-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl text-sm font-bold hover:from-blue-700 hover:to-indigo-700 transition-all shadow-md hover:shadow-lg">
            ì¶”ê°€í•˜ê¸°
          </button>
        </div>

        <div class="bg-slate-50 border border-slate-100 rounded-xl p-4 mt-2">
          <p class="text-[11px] text-slate-500 leading-relaxed">
            <span class="font-bold text-slate-600">ğŸ’¡ TIP:</span>
            ì…€ëŸ¬ëª…ë§Œ ì…ë ¥í•˜ë©´ ì…€ëŸ¬ë§Œ ì¶”ê°€ë©ë‹ˆë‹¤. ìƒí’ˆëª…ê¹Œì§€ ì…ë ¥í•˜ë©´ ì…€ëŸ¬-ìƒí’ˆ ì—°ê²°ì´ ìƒì„±ë©ë‹ˆë‹¤.
            í–‰ì‚¬ì¼/ë§¤ì¶œê¹Œì§€ ì…ë ¥í•˜ë©´ ë§¤ì¶œ ê¸°ë¡ë„ í•¨ê»˜ ìƒì„±ë©ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- ì…€ëŸ¬ ëª¨ë‹¬ -->
  <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
    <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-2xl overflow-hidden animate-in zoom-in duration-150">
      <div class="p-8 border-b bg-slate-50 relative">
        <h2 id="modalTitle" class="text-2xl font-black text-slate-800 tracking-tight uppercase leading-none"></h2>
        <button onclick="closeModal()" class="absolute top-8 right-8 text-slate-400 hover:text-slate-600 font-bold text-2xl">Ã—</button>
        <div class="flex gap-1 mt-4">
          <button id="tabRel" onclick="switchTab('rel')" class="text-xs font-black uppercase px-4 py-2 text-slate-400 border-b-2 border-transparent transition-all active-tab">í–‰ì‚¬ìƒí’ˆ</button>
          <button id="tabLog" onclick="switchTab('log')" class="text-xs font-black uppercase px-4 py-2 text-slate-400 border-b-2 border-transparent transition-all">ì¼ì •/ë§¤ì¶œ ê¸°ë¡</button>
        </div>
      </div>
      <div class="p-8">
        <div id="tabContentRel">
          <div id="modalItemList" class="flex flex-wrap gap-2 max-h-96 overflow-y-auto custom-scrollbar pr-1"></div>
        </div>

        <div id="tabContentLog" class="hidden space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="flex flex-col gap-1">
              <label class="text-[10px] font-bold text-slate-400 uppercase">í–‰ì‚¬ì¼</label>
              <input type="date" id="logDate" class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex flex-col gap-1 min-w-0">
              <label class="text-[10px] font-bold text-slate-400 uppercase">ìƒí’ˆ</label>
              <div class="flex gap-1">
                <input type="text" id="logProduct" list="logProductList"
                       class="min-w-0 w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="ìƒí’ˆ ì„ íƒ ë˜ëŠ” ì…ë ¥">
              </div>
              <datalist id="logProductList"></datalist>
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-[10px] font-bold text-slate-400 uppercase">ë§¤ì¶œì•¡(ì–µì›)</label>
              <input type="number" id="logRevenue" step="0.01" class="w-full px-3 py-2 border rounded-lg text-sm outline-none" placeholder="0.00">
            </div>
          </div>

          <button id="submitLogBtn" onclick="submitLog()" class="w-full bg-blue-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-blue-700 shadow-sm">ê¸°ë¡ ì¶”ê°€/ìˆ˜ì •</button>
          <div id="logHistoryList" class="space-y-2 max-h-56 overflow-y-auto custom-scrollbar pr-1 pt-2"></div>
          <div class="text-[11px] text-slate-400 font-bold">
            * ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ í•­ëª© í´ë¦­: ì„ íƒ(íŒŒë€ í…Œë‘ë¦¬) / ë‹¤ì‹œ í´ë¦­: ì„ íƒ í•´ì œ + ì…ë ¥ ì´ˆê¸°í™”
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ìƒí’ˆ ë¶„ì„ ëª¨ë‹¬ -->
  <div id="productModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
    <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-2xl overflow-hidden animate-in zoom-in duration-150">
      <div class="p-8 border-b bg-slate-50 relative">
        <h2 id="productModalTitle" class="text-2xl font-black text-slate-800 tracking-tight uppercase leading-none text-emerald-600">ìƒí’ˆ ë¶„ì„</h2>
        <button onclick="closeProductModal()" class="absolute top-8 right-8 text-slate-400 hover:text-slate-600 font-bold text-2xl">Ã—</button>
        <p id="productModalSubtitle" class="mt-3 text-xs font-bold text-slate-400 uppercase tracking-wider"></p>
      </div>
      <div class="p-8 space-y-6">
        <div class="bg-white p-6 rounded-[1.8rem] border border-slate-200 shadow-sm">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-black text-slate-800 uppercase tracking-tight">ì…€ëŸ¬ë³„ ë§¤ì¶œ</h3>
            <span id="productSellerTotal" class="text-xs font-black text-emerald-600"></span>
          </div>
          <div id="productSellerList" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar pr-1"></div>
        </div>
        <div class="bg-slate-50 border border-slate-100 rounded-[1.8rem] p-5">
          <p class="text-[11px] font-bold text-slate-500 leading-relaxed">
            * í˜„ì¬ ìƒë‹¨ ê¸°ê°„ í•„í„°(ì—°/ì›”)ì— ë§ì¶° ì§‘ê³„ë©ë‹ˆë‹¤. (ì›” ì„ íƒ ì‹œ: í•´ë‹¹ ì›” / ì—°ë„ë§Œ ì„ íƒ ì‹œ: í•´ë‹¹ ì—°ë„ / ë¯¸ì„ íƒ: ì „ì²´)
          </p>
        </div>
      </div>
    </div>
  </div>

<script>
  // -------------------------
  // State
  // -------------------------
  let rawData = [];
  let salesLogs = [];
  let currentView = 'seller';
  let sellerFilter = 'all';
  let statsMode = 'seller';

  let currentTarget = '';
  let editingLogId = null;

  let currentProductTarget = '';
  let pendingJumpToTodayOnNav = false;

  // Calendar state
  let calendarYear = new Date().getFullYear();
  let calendarMonth = new Date().getMonth();
  let selectedCalendarDate = null;

  let helpPopupWin = null;

  // Print state
  let calendarPrintOrientation = 'portrait'; // 'portrait' | 'landscape'

  const koreanSort = (a, b) => (a || '').localeCompare((b || ''), 'ko');

  // -------------------------
  // Local Storage
  // -------------------------
  function saveToLocal() {
    localStorage.setItem('sorted_rawData', JSON.stringify(rawData));
    localStorage.setItem('sorted_salesLogs', JSON.stringify(salesLogs));
  }

  function loadFromLocal() {
    rawData = JSON.parse(localStorage.getItem('sorted_rawData') || '[]');
    salesLogs = JSON.parse(localStorage.getItem('sorted_salesLogs') || '[]');
    if (!Array.isArray(rawData)) rawData = [];
    if (!Array.isArray(salesLogs)) salesLogs = [];
    rawData.sort((a,b) => koreanSort(a.name, b.name));
    salesLogs.sort((a,b) => (b.date||'').localeCompare(a.date||''));
  }

  // -------------------------
  // Filter period
  // -------------------------
  function getPeriod() {
    const y = document.getElementById('filterYear').value;
    const m = document.getElementById('filterMonth').value;
    if (y && m) return { year: y, month: m, label: `${y}ë…„ ${m}ì›”` };
    if (y) return { year: y, month: null, label: y };
    return { year: null, month: null, label: 'ì „ì²´' };
  }

  function filterLogsByPeriod(logs) {
    const { year, month } = getPeriod();
    return logs.filter(l => {
      if (!l.date) return false;
      const d = String(l.date);
      if (year && month) return d.startsWith(`${year}-${month}`);
      if (year) return d.startsWith(year);
      return true;
    });
  }

  function resetGlobalFilter() {
    document.getElementById('filterYear').value = '';
    document.getElementById('filterMonth').value = '';
    pendingJumpToTodayOnNav = true;
    renderAll();
  }

  // -------------------------
  // Utility
  // -------------------------
  const uniqueSorted = arr => [...new Set(arr.filter(Boolean))].sort(koreanSort);

  // -------------------------
  // View switching
  // -------------------------
  function switchView(v) {
    currentView = v;
    ['seller', 'product', 'calendar', 'stats'].forEach(k => {
      const btn = document.getElementById('view' + k.charAt(0).toUpperCase() + k.slice(1) + 'Btn');
      if (btn) {
        btn.classList.toggle('active-view-btn', k === v);
        btn.classList.toggle('text-slate-500', k !== v);
      }
    });

    document.getElementById('mainGrid').classList.toggle('hidden', v === 'stats' || v === 'calendar');
    document.getElementById('statsView').classList.toggle('hidden', v !== 'stats');
    document.getElementById('calendarView').classList.toggle('hidden', v !== 'calendar');
    document.getElementById('sellerFilterGroup').classList.toggle('hidden', v !== 'seller');
    document.getElementById('searchArea').classList.toggle('hidden', v === 'stats' || v === 'calendar');

    if (v === 'calendar') closeSelectedDateEvents();

    // âœ… ìº˜ë¦°ë”ëŠ” í•œ í˜ì´ì§€ì— ë§ì¶”ê¸° ìœ„í•´ main padding ì•½ê°„ ì¤„ì´ê¸°
    const mainArea = document.getElementById('mainArea');
    if (mainArea) {
      if (v === 'calendar') mainArea.classList.add('p-3');
      else mainArea.classList.remove('p-3');
    }

    renderAll();
  }

  function setSellerFilter(f) {
    sellerFilter = f;
    ['All', 'Has', 'No'].forEach(k => {
      const btn = document.getElementById('filter' + k);
      const active = (f === 'all' && k === 'All') || (f === 'hasProduct' && k === 'Has') || (f === 'noProduct' && k === 'No');
      btn.classList.toggle('active-filter-btn', active);
      btn.classList.toggle('text-white', active);
      btn.classList.toggle('text-slate-500', !active);
    });
    renderAll();
  }

  function setStatsMode(m) {
    statsMode = m;
    document.getElementById('statsModeSeller').classList.toggle('active-filter-btn', m === 'seller');
    document.getElementById('statsModeSeller').classList.toggle('text-white', m === 'seller');
    document.getElementById('statsModeSeller').classList.toggle('text-slate-500', m !== 'seller');
    document.getElementById('statsModeProduct').classList.toggle('active-filter-btn', m === 'product');
    document.getElementById('statsModeProduct').classList.toggle('text-white', m === 'product');
    document.getElementById('statsModeProduct').classList.toggle('text-slate-500', m !== 'product');
    renderStats();
  }

  // -------------------------
  // Render all
  // -------------------------
  function renderAll() {
    if (currentView === 'stats') {
      renderStats();
    } else if (currentView === 'calendar') {
      renderCalendar();
    } else {
      renderGrid();
    }
    if (currentTarget) refreshSellerModalOnPeriodChange();
    if (currentProductTarget) openProductModal(currentProductTarget);
  }

  // -------------------------
  // Calendar Functions
  // -------------------------
  function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';

    const firstDay = new Date(calendarYear, calendarMonth, 1);
    const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
    const startDayOfWeek = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    const monthEvents = getEventsForMonth(calendarYear, calendarMonth);

    // prev month
    const prevMonth = new Date(calendarYear, calendarMonth, 0);
    const prevMonthDays = prevMonth.getDate();
    for (let i = startDayOfWeek - 1; i >= 0; i--) {
      const day = prevMonthDays - i;
      const cell = createCalendarCell(day, true, [], calendarYear, calendarMonth - 1);
      grid.appendChild(cell);
    }

    // current month
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${calendarYear}-${String(calendarMonth + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      const dayEvents = monthEvents[dateStr] || [];
      const isToday = today.getFullYear() === calendarYear && today.getMonth() === calendarMonth && today.getDate() === day;
      const cell = createCalendarCell(day, false, dayEvents, calendarYear, calendarMonth, isToday, dateStr);
      grid.appendChild(cell);
    }

    // next month
    const totalCells = Math.ceil((startDayOfWeek + daysInMonth) / 7) * 7;
    const remainingCells = totalCells - (startDayOfWeek + daysInMonth);
    for (let day = 1; day <= remainingCells; day++) {
      const cell = createCalendarCell(day, true, [], calendarYear, calendarMonth + 1);
      grid.appendChild(cell);
    }

    requestAnimationFrame(() => {
      renderCalendarEvents();
      makeEventsDraggable();
      setupDropZones();
    });
  }

  function createCalendarCell(day, isOtherMonth, events, year, month, isToday = false, dateStr = '') {
    const cell = document.createElement('div');
    let classes = 'calendar-day';
    if (isOtherMonth) classes += ' other-month';
    if (isToday) classes += ' today';
    if (events.length > 0 && !isOtherMonth) classes += ' has-events';
    cell.className = classes;
    cell.setAttribute('data-date', dateStr);
    cell.setAttribute('data-events', JSON.stringify(events));

    const dayNum = document.createElement('div');
    dayNum.className = `calendar-day-num font-bold flex-shrink-0 ${isToday ? 'text-blue-600' : isOtherMonth ? 'text-slate-300' : 'text-slate-700'}`;
    dayNum.textContent = day;
    cell.appendChild(dayNum);

    const eventsContainer = document.createElement('div');
    eventsContainer.className = 'calendar-events-container';
    cell.appendChild(eventsContainer);

    if (!isOtherMonth && dateStr) {
      cell.onclick = (e) => {
        if (e.target.closest('.calendar-event') || e.target.closest('.calendar-more-btn')) return;
        if (events.length > 0) showSelectedDateEvents(dateStr, events);
      };
      cell.style.cursor = events.length > 0 ? 'pointer' : 'default';
    }

    return cell;
  }

  // âœ… ì…€ ë†’ì´ì— ë§ì¶° ì´ë²¤íŠ¸ ê°œìˆ˜ ê³„ì‚°/í‘œì‹œ
  function renderCalendarEvents() {
    const cells = document.querySelectorAll('.calendar-day:not(.other-month)');

    cells.forEach(cell => {
      const eventsContainer = cell.querySelector('.calendar-events-container');
      if (!eventsContainer) return;

      let events = [];
      try { events = JSON.parse(cell.getAttribute('data-events') || '[]'); } catch(e) { events = []; }
      if (!events.length) return;

      eventsContainer.innerHTML = '';

      const containerHeight = eventsContainer.clientHeight;

      // âœ… ê³ ì • ë†’ì´ ì‚¬ìš© (16px + 2px gap)
      const eventHeight = 18;

      const totalSlots = Math.floor(containerHeight / Math.max(1, eventHeight));

      let visibleCount;
      let showMoreButton;

      if (events.length <= totalSlots) {
        visibleCount = events.length;
        showMoreButton = false;
      } else {
        visibleCount = Math.max(1, totalSlots - 1);
        showMoreButton = true;
      }

      for (let i = 0; i < visibleCount; i++) {
        const event = events[i];
        const eventEl = document.createElement('div');
        eventEl.className = `calendar-event event-color-${i % 6}`;

        const revText = Number(event.revenue || 0).toFixed(1) + 'ì–µ';
        
        // âœ… í…ìŠ¤íŠ¸ ì§ì ‘ ì„¤ì • (block ìš”ì†Œì´ë¯€ë¡œ)
        eventEl.textContent = `${event.seller}-${event.product}-${revText}`;
        
        eventEl.title = `ì…€ëŸ¬: ${event.seller}\nìƒí’ˆ: ${event.product}\në§¤ì¶œ: ${Number(event.revenue || 0).toFixed(2)}ì–µ`;
        eventEl.setAttribute('data-log-id', event.id);

        eventEl.onclick = (e) => {
          e.stopPropagation();
          syncCalendarFilterToHeader();
          openSellerModal(event.seller, { logId: event.id });
        };
        eventsContainer.appendChild(eventEl);
      }

      if (showMoreButton) {
        const moreEl = document.createElement('div');
        moreEl.className = 'calendar-more-btn';
        moreEl.textContent = `+${events.length - visibleCount}ê°œ`;
        moreEl.onclick = (e) => {
          e.stopPropagation();
          e.preventDefault();
          const dateStr = cell.getAttribute('data-date');
          showSelectedDateEvents(dateStr, events);
        };
        eventsContainer.appendChild(moreEl);
      }
    });
  }

  function syncCalendarFilterToHeader() {
    document.getElementById('filterYear').value = String(calendarYear);
    document.getElementById('filterMonth').value = String(calendarMonth + 1).padStart(2, '0');
  }

  function getEventsForMonth(year, month) {
    const events = {};
    const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;

    salesLogs.forEach(log => {
      if (log.date && log.date.startsWith(monthStr)) {
        if (!events[log.date]) events[log.date] = [];
        events[log.date].push(log);
      }
    });

    Object.keys(events).forEach(date => {
      events[date].sort((a, b) => (b.revenue || 0) - (a.revenue || 0));
    });

    return events;
  }

  function navigatePeriod(direction) {
    const y = document.getElementById('filterYear')?.value;
    const m = document.getElementById('filterMonth')?.value;

    if (pendingJumpToTodayOnNav || !(y && m)) {
      const today = new Date();
      calendarYear = today.getFullYear();
      calendarMonth = today.getMonth();
      setHeaderFromCalendarState();
      pendingJumpToTodayOnNav = false;

      closeSelectedDateEvents();
      if (currentView === 'calendar') renderCalendar();
      else renderAll();
      return;
    }

    syncCalendarStateFromHeader();

    calendarMonth += direction;
    if (calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
    else if (calendarMonth > 11) { calendarMonth = 0; calendarYear++; }

    setHeaderFromCalendarState();
    closeSelectedDateEvents();
    if (currentView === 'calendar') renderCalendar();
    else renderAll();
  }

  function syncCalendarStateFromHeader() {
    const y = document.getElementById('filterYear')?.value;
    const m = document.getElementById('filterMonth')?.value;
    if (y && m) {
      calendarYear = parseInt(y, 10);
      calendarMonth = parseInt(m, 10) - 1;
    }
  }

  function setHeaderFromCalendarState() {
    document.getElementById('filterYear').value = String(calendarYear);
    document.getElementById('filterMonth').value = String(calendarMonth + 1).padStart(2, '0');
  }

  function showSelectedDateEvents(dateStr, events) {
    selectedCalendarDate = dateStr;
    const container = document.getElementById('selectedDateEvents');
    const title = document.getElementById('selectedDateTitle');
    const list = document.getElementById('selectedDateEventsList');

    const [year, month, day] = dateStr.split('-');
    title.textContent = `${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼ ì¼ì • (${events.length}ê±´)`;

    list.innerHTML = '';
    const totalRevenue = events.reduce((sum, e) => sum + (e.revenue || 0), 0);

    const summary = document.createElement('div');
    summary.className = 'bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100 mb-4';
    summary.innerHTML = `
      <div class="flex justify-between items-center">
        <span class="text-sm font-bold text-slate-600">ì´ ë§¤ì¶œ</span>
        <span class="text-lg font-black text-blue-600">${totalRevenue.toFixed(2)}ì–µì›</span>
      </div>
    `;
    list.appendChild(summary);

    events.forEach((event, idx) => {
      const item = document.createElement('div');
      item.className = `flex items-center justify-between p-4 rounded-xl border border-slate-100 hover:shadow-md transition-all cursor-pointer event-color-${idx % 6}`;
      item.innerHTML = `
        <div class="flex-1">
          <div class="font-black text-sm">${escapeHtml(event.seller)} - ${escapeHtml(event.product)}</div>
        </div>
        <div class="text-right">
          <div class="font-black text-blue-600">${Number(event.revenue || 0).toFixed(2)}ì–µ</div>
        </div>
      `;
      item.onclick = () => {
        syncCalendarFilterToHeader();
        openSellerModal(event.seller, { logId: event.id });
      };
      list.appendChild(item);
    });

    container.classList.remove('hidden');
  }

  function closeSelectedDateEvents() {
    document.getElementById('selectedDateEvents').classList.add('hidden');
    selectedCalendarDate = null;
  }

  // -------------------------
  // Drag & Drop
  // -------------------------
  function makeEventsDraggable() {
    document.querySelectorAll('.calendar-event').forEach(el => {
      el.draggable = true;

      el.addEventListener('dragstart', (e) => {
        const eventEl = e.target.closest('.calendar-event');
        if (!eventEl) return;

        const logId = eventEl.getAttribute('data-log-id');
        const cell = eventEl.closest('.calendar-day');
        const originalDate = cell.getAttribute('data-date');
        if (!logId) return;

        e.dataTransfer.setData('text/plain', JSON.stringify({
          logId: parseInt(logId, 10),
          originalDate
        }));

        eventEl.classList.add('opacity-50');
      });

      el.addEventListener('dragend', (e) => {
        e.target.classList.remove('opacity-50');
      });
    });
  }

  function setupDropZones() {
    document.querySelectorAll('.calendar-day:not(.other-month)').forEach(cell => {
      cell.addEventListener('dragover', (e) => {
        e.preventDefault();
        cell.classList.add('ring-2', 'ring-blue-400', 'bg-blue-50/30');
      });

      cell.addEventListener('dragleave', () => {
        cell.classList.remove('ring-2', 'ring-blue-400', 'bg-blue-50/30');
      });

      cell.addEventListener('drop', (e) => {
        e.preventDefault();
        cell.classList.remove('ring-2', 'ring-blue-400', 'bg-blue-50/30');

        const data = e.dataTransfer.getData('text/plain');
        if (!data) return;

        try {
          const { logId, originalDate } = JSON.parse(data);
          const newDate = cell.getAttribute('data-date');
          if (newDate === originalDate) return;

          const log = salesLogs.find(l => l.id === logId);
          if (log) {
            log.date = newDate;
            salesLogs.sort((a,b) => (b.date||'').localeCompare(a.date||''));
            saveToLocal();
            renderCalendar();
          }
        } catch (err) {
          console.error('ë“œë¡­ ì²˜ë¦¬ ì˜¤ë¥˜:', err);
        }
      });
    });
  }

  // -------------------------
  // Grid render (seller/product)
  // -------------------------
  function createEmptyStateCard(type) {
    const card = document.createElement('div');
    card.className = "empty-state-card bg-white rounded-[2rem] p-8 shadow-sm cursor-pointer transition-all col-span-full flex flex-col items-center justify-center min-h-[200px]";
    card.onclick = () => openNewEntryModal();

    const icon = type === 'seller' ? 'ğŸ‘¤' : 'ğŸ“¦';
    const title = type === 'seller' ? 'ë“±ë¡ëœ ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤' : 'ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤';
    const subtitle = 'í´ë¦­í•˜ì—¬ ì²« ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”';

    card.innerHTML = `
      <div class="text-5xl mb-4">${icon}</div>
      <h3 class="text-lg font-black text-slate-400 mb-2">${title}</h3>
      <p class="text-sm text-slate-400">${subtitle}</p>
      <button class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-xl text-sm font-bold hover:bg-blue-700 transition-all">
        + ì‹ ê·œ ì¶”ê°€
      </button>
    `;
    return card;
  }

  function createCard(title, items, badge, salesTotal, salesLabel) {
    const div = document.createElement('div');
    div.className = "bg-white rounded-[2rem] p-6 shadow-sm cursor-pointer hover:shadow-lg transition-all card-animate border border-slate-100 hover:border-blue-200";
    div.onclick = () => {
      if (badge === 'SELLER') openSellerModal(title);
      else openProductModal(title);
    };
    div.innerHTML = `
      <span class="text-[9px] font-black uppercase px-2 py-1 rounded-lg ${badge === 'SELLER' ? 'bg-blue-50 text-blue-600' : 'bg-emerald-50 text-emerald-600'}">${badge}</span>
      <h3 class="text-lg font-black text-slate-800 mt-3 mb-2 tracking-tight leading-tight">${escapeHtml(title)}</h3>
      <div class="flex flex-wrap gap-1 mb-3 max-h-20 overflow-hidden">
        ${items.slice(0, 5).map(i => `<span class="text-[10px] font-medium text-slate-400 bg-slate-100 px-2 py-1 rounded-lg">${escapeHtml(i)}</span>`).join('')}
        ${items.length > 5 ? `<span class="text-[10px] font-bold text-slate-500">+${items.length - 5}</span>` : ''}
      </div>
      <div class="pt-3 border-t border-slate-100 flex justify-between items-center">
        <span class="text-[10px] font-bold text-slate-400 uppercase">${salesLabel}</span>
        <span class="text-sm font-black text-blue-600">${Number(salesTotal || 0).toFixed(2)}ì–µ</span>
      </div>
    `;
    return div;
  }

  function renderGrid() {
    const grid = document.getElementById('mainGrid');
    grid.innerHTML = "";

    const { label } = getPeriod();
    const salesLabel = (label === 'ì „ì²´') ? 'ì´ ë§¤ì¶œ' : `${label} ë§¤ì¶œ`;
    const search = (document.getElementById('globalSearch').value || '').toLowerCase();
    let hasVisibleCards = false;

    if (currentView === 'seller') {
      rawData.forEach(s => {
        const logs = filterLogsByPeriod(salesLogs.filter(l => l.seller === s.name));
        const productsInPeriod = uniqueSorted(logs.map(l => l.product));
        const hasProd = productsInPeriod.length > 0;

        if (sellerFilter === 'hasProduct' && !hasProd) return;
        if (sellerFilter === 'noProduct' && hasProd) return;

        const sales = logs.reduce((sum, l) => sum + Number(l.revenue || 0), 0);
        const matchesSearch =
          (s.name || '').toLowerCase().includes(search) ||
          productsInPeriod.some(p => (p || '').toLowerCase().includes(search));

        if (!matchesSearch) return;

        hasVisibleCards = true;
        grid.appendChild(createCard(s.name, productsInPeriod, 'SELLER', sales, salesLabel));
      });

      if (!hasVisibleCards) {
        if (search) grid.innerHTML = `<div class='text-center py-12 text-slate-300 font-black uppercase col-span-full'>ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;
        else grid.appendChild(createEmptyStateCard('seller'));
      }
    } else if (currentView === 'product') {
      const productMap = new Map();
      rawData.forEach(s => (s.products || []).forEach(p => { if (!productMap.has(p)) productMap.set(p, []); }));
      salesLogs.forEach(l => { if (l.product && !productMap.has(l.product)) productMap.set(l.product, []); });

      [...productMap.keys()].sort(koreanSort).forEach(p => {
        const logs = filterLogsByPeriod(salesLogs.filter(l => l.product === p));
        const sales = logs.reduce((sum, l) => sum + Number(l.revenue || 0), 0);
        const sellersInPeriod = uniqueSorted(logs.map(l => l.seller));

        const matchesSearch =
          (p || '').toLowerCase().includes(search) ||
          sellersInPeriod.some(n => (n || '').toLowerCase().includes(search));

        if (!matchesSearch) return;

        hasVisibleCards = true;
        grid.appendChild(createCard(p, sellersInPeriod, 'PRODUCT', sales, salesLabel));
      });

      if (!hasVisibleCards) {
        if (search) grid.innerHTML = `<div class='text-center py-12 text-slate-300 font-black uppercase col-span-full'>ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;
        else grid.appendChild(createEmptyStateCard('product'));
      }
    }
  }

  // -------------------------
  // Stats
  // -------------------------
  function renderStats() {
    if (currentView !== 'stats') return;

    const { label } = getPeriod();
    document.getElementById('statsDisplayTitle').innerText = (label === 'ì „ì²´') ? 'ì „ì²´ í†µí•© ë¶„ì„' : `${label} ìƒì„¸ ë¶„ì„`;

    const filteredLogs = filterLogsByPeriod(salesLogs);
    const totalRevenue = filteredLogs.reduce((sum, l) => sum + Number(l.revenue || 0), 0);
    document.getElementById('totalMonthRevenue').innerHTML = `${totalRevenue.toFixed(2)} <span class="text-xl font-bold">ì–µì›</span>`;

    const agg = {};
    filteredLogs.forEach(l => {
      const key = (statsMode === 'seller') ? l.seller : l.product;
      if (!key) return;
      agg[key] = (agg[key] || 0) + Number(l.revenue || 0);
    });

    const sorted = Object.entries(agg).sort((a,b)=>b[1]-a[1]);
    const container = document.getElementById('statsTableContainer');
    container.innerHTML = "";

    if (!sorted.length) {
      container.innerHTML = `
        <div class='text-center py-12'>
          <div class="text-slate-300 font-black uppercase mb-4">No Data</div>
          <button onclick="openNewEntryModal()" class="px-4 py-2 bg-blue-600 text-white rounded-xl text-xs font-bold hover:bg-blue-700 transition-all">
            + ë°ì´í„° ì¶”ê°€í•˜ê¸°
          </button>
        </div>`;
      return;
    }

    sorted.forEach(([name, rev], idx) => {
      const percent = totalRevenue > 0 ? (rev / totalRevenue * 100).toFixed(1) : '0.0';
      const row = document.createElement('div');
      row.className = "flex items-center gap-4 bg-slate-50 p-4 rounded-2xl border border-slate-100 hover:bg-white hover:shadow-md transition-all";
      row.innerHTML = `
        <div class="w-8 h-8 flex items-center justify-center bg-blue-600 rounded-full text-[10px] font-black text-white">${idx + 1}</div>
        <div class="flex-1">
          <div class="flex justify-between items-center mb-1">
            <h5 class="text-sm font-black text-slate-800">${escapeHtml(name)}</h5>
            <span class="text-xs font-bold text-blue-600">${Number(rev||0).toFixed(2)}ì–µ</span>
          </div>
          <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
            <div class="bg-blue-500 h-full transition-all duration-700" style="width: ${percent}%;"></div>
          </div>
        </div>
        <div class="text-right w-12 text-[11px] font-black text-slate-400">${percent}%</div>
      `;
      container.appendChild(row);
    });
  }

  // -------------------------
  // ì‹ ê·œ ë°ì´í„°
  // -------------------------
  function openNewEntryModal() {
    updateNewEntryDataLists();
    document.getElementById('newSellerName').value = '';
    document.getElementById('newProductName').value = '';
    document.getElementById('newEventDate').value = '';
    document.getElementById('newRevenue').value = '';
    document.getElementById('newEntryModal').classList.remove('hidden');
    setTimeout(() => { document.getElementById('newSellerName').focus(); }, 100);
  }

  function closeNewEntryModal() {
    document.getElementById('newEntryModal').classList.add('hidden');
  }

  function updateNewEntryDataLists() {
    const sellersList = document.getElementById('existingSellersList');
    sellersList.innerHTML = '';
    const sellers = uniqueSorted(rawData.map(s => s.name));
    sellers.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      sellersList.appendChild(opt);
    });

    const productsList = document.getElementById('existingProductsList');
    productsList.innerHTML = '';
    const products = getGlobalMasterProducts();
    products.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      productsList.appendChild(opt);
    });
  }

  function submitNewEntry() {
    const sellerName = (document.getElementById('newSellerName').value || '').trim();
    const productName = (document.getElementById('newProductName').value || '').trim();
    const eventDate = document.getElementById('newEventDate').value || '';
    const revenueVal = document.getElementById('newRevenue').value;
    const revenue = revenueVal ? Number(revenueVal) : null;

    if (!sellerName) {
      alert('ì…€ëŸ¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      document.getElementById('newSellerName').focus();
      return;
    }

    let seller = rawData.find(s => s.name === sellerName);
    if (!seller) {
      seller = { name: sellerName, products: [] };
      rawData.push(seller);
      rawData.sort((a, b) => koreanSort(a.name, b.name));
    }

    if (productName) {
      if (!seller.products.includes(productName)) {
        seller.products.push(productName);
        seller.products = uniqueSorted(seller.products);
      }

      if (eventDate || revenue !== null) {
        salesLogs.push({
          id: Date.now(),
          seller: sellerName,
          product: productName,
          date: eventDate,
          revenue: revenue !== null ? revenue : 0
        });
        salesLogs.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
      }
    }

    saveToLocal();
    closeNewEntryModal();
    renderAll();
  }

  // -------------------------
  // Seller modal
  // -------------------------
  function switchTab(t) {
    const isRel = t === 'rel';
    document.getElementById('tabRel').classList.toggle('active-tab', isRel);
    document.getElementById('tabLog').classList.toggle('active-tab', !isRel);
    document.getElementById('tabRel').classList.toggle('text-slate-400', !isRel);
    document.getElementById('tabLog').classList.toggle('text-slate-400', isRel);
    document.getElementById('tabContentRel').classList.toggle('hidden', !isRel);
    document.getElementById('tabContentLog').classList.toggle('hidden', isRel);
  }

  function getCurrentSeller() {
    return rawData.find(s => s.name === currentTarget) || null;
  }

  function openSellerModal(sellerName, opts = {}) {
    currentTarget = sellerName;
    editingLogId = null;

    document.getElementById('modalTitle').innerText = sellerName;
    document.getElementById('modal').classList.remove('hidden');

    updateLogProductDropdownMaster();
    resetLogFields();
    renderModalItemsPeriod();
    renderLogHistoryPeriod();

    if (opts.logId) {
      const log = salesLogs.find(l => l.id === opts.logId);
      if (log) {
        switchTab('log');
        selectLog(log);
        return;
      }
    }
    switchTab('rel');
  }

  function closeModal() {
    document.getElementById('modal').classList.add('hidden');
    currentTarget = '';
    editingLogId = null;
    resetLogFields();
  }

  function refreshSellerModalOnPeriodChange() {
    if (editingLogId) {
      const visibleIds = new Set(filterLogsByPeriod(salesLogs.filter(l => l.seller === currentTarget)).map(l => l.id));
      if (!visibleIds.has(editingLogId)) {
        editingLogId = null;
        resetLogFields();
      }
    }
    updateLogProductDropdownMaster();
    renderModalItemsPeriod();
    renderLogHistoryPeriod();
  }

  function renderModalItemsPeriod() {
    const listEl = document.getElementById('modalItemList');
    listEl.innerHTML = "";
    if (!currentTarget) return;

    const sellerLogs = filterLogsByPeriod(salesLogs.filter(l => l.seller === currentTarget));
    const products = uniqueSorted(sellerLogs.map(l => l.product));

    if (!products.length) {
      listEl.innerHTML = `
        <div class="text-center py-10 text-slate-300 font-black uppercase w-full">
          ì—°ê²° ìƒí’ˆ ì—†ìŒ
          <div class="mt-2 text-[11px] font-bold text-slate-400 normal-case">
            ì‹ ê·œ ì…ë ¥ì€ <b>ì¼ì •/ë§¤ì¶œ ê¸°ë¡</b> íƒ­ì—ì„œ ì „ì²´ ì—°ê²° ìƒí’ˆì„ ì„ íƒí•´ ì¶”ê°€í•˜ì„¸ìš”.
          </div>
        </div>`;
      return;
    }

    products.forEach(p => {
      const pLogs = sellerLogs.filter(l => l.product === p);
      const totalSales = pLogs.reduce((sum, l) => sum + Number(l.revenue || 0), 0);
      const dates = uniqueSorted(pLogs.map(l => l.date)).slice(0, 3).join(', ');

      const chip = document.createElement('div');
      chip.className = "bg-white text-slate-700 px-3 py-2 rounded-xl text-xs font-bold border border-slate-200 shadow-sm flex items-center gap-2 hover:bg-blue-50 transition-all cursor-pointer";
      chip.innerHTML = `
        <span>${escapeHtml(p)}</span>
        ${dates ? `<span class="text-blue-500 font-black ml-1 text-[9px] bg-blue-50 px-1.5 py-0.5 rounded-lg border border-blue-100 shadow-sm">${escapeHtml(dates)}</span>` : ''}
        <span class="text-slate-400 font-normal">(${totalSales.toFixed(2)}ì–µ)</span>
      `;
      chip.onclick = () => {
        switchTab('log');
        document.getElementById('logProduct').value = p;
        const latest = pLogs.slice().sort((a,b) => (b.date||'').localeCompare(a.date||''))[0];
        if (latest) selectLog(latest, { fromRelClick: true });
        else {
          editingLogId = null;
          resetLogFields({ keepProduct: true });
          renderLogHistoryPeriod();
        }
      };
      listEl.appendChild(chip);
    });
  }

  function getGlobalMasterProducts() {
    const set = new Set();
    (rawData || []).forEach(s => (s.products || []).forEach(p => { if (p) set.add(p); }));
    (salesLogs || []).forEach(l => { if (l && l.product) set.add(l.product); });
    return uniqueSorted(Array.from(set));
  }

  function updateLogProductDropdownMaster() {
    const input = document.getElementById('logProduct');
    const datalist = document.getElementById('logProductList');
    if (!input || !datalist) return;

    const currentValue = input.value || "";
    datalist.innerHTML = "";

    const products = getGlobalMasterProducts();
    products.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p;
      datalist.appendChild(opt);
    });

    input.value = currentValue;
  }

  function renderLogHistoryPeriod() {
    const container = document.getElementById('logHistoryList');
    container.innerHTML = "";
    if (!currentTarget) return;

    const logs = filterLogsByPeriod(salesLogs.filter(l => l.seller === currentTarget))
      .slice()
      .sort((a,b) => (b.date||'').localeCompare(a.date||''));

    if (!logs.length) {
      container.innerHTML = "<div class='text-center py-10 text-slate-300 font-black uppercase'>No History</div>";
      return;
    }

    logs.forEach(l => {
      const div = document.createElement('div');
      const isSelected = (l.id === editingLogId);
      div.className = `flex justify-between items-center p-3 bg-white rounded-xl border border-slate-200 shadow-sm cursor-pointer hover:border-blue-400 transition-all group ${isSelected ? 'selected-log-item' : ''}`;

      div.onclick = (e) => {
        if (e.target.closest('button')) return;
        if (editingLogId === l.id) {
          editingLogId = null;
          resetLogFields();
          renderLogHistoryPeriod();
        } else {
          selectLog(l);
        }
      };

      div.innerHTML = `
        <div class="flex flex-col">
          <span class="text-[9px] font-black text-blue-500 uppercase">${escapeHtml(l.date || 'ë‚ ì§œ ë¯¸ì •')}</span>
          <span class="text-xs font-bold text-slate-700">
            ${escapeHtml(l.product || '')} - <span class="text-blue-700">${Number(l.revenue || 0).toFixed(2)}ì–µ</span>
          </span>
        </div>
        <button onclick="deleteLog(${l.id})" class="text-slate-300 hover:text-red-500 transition-all">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      `;
      container.appendChild(div);
    });
  }

  function selectLog(log) {
    editingLogId = log.id;
    document.getElementById('logDate').value = log.date || '';
    document.getElementById('logProduct').value = log.product || '';
    document.getElementById('logRevenue').value = log.revenue ?? '';
    document.getElementById('submitLogBtn').innerText = 'ê¸°ë¡ ìˆ˜ì •';
    renderLogHistoryPeriod();
  }

  function resetLogFields(opts = {}) {
    document.getElementById('logDate').value = '';
    if (!opts.keepProduct) document.getElementById('logProduct').value = '';
    document.getElementById('logRevenue').value = '';
    document.getElementById('submitLogBtn').innerText = 'ê¸°ë¡ ì¶”ê°€/ìˆ˜ì •';
  }

  function submitLog() {
    const date = document.getElementById('logDate').value;
    const product = (document.getElementById('logProduct').value || '').trim();
    const rev = parseFloat(document.getElementById('logRevenue').value) || 0;

    if (!product) { alert('ìƒí’ˆì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

    const seller = getCurrentSeller();
    if (seller && !seller.products.includes(product)) {
      seller.products.push(product);
      seller.products = uniqueSorted(seller.products);
    }

    if (editingLogId) {
      const log = salesLogs.find(l => l.id === editingLogId);
      if (log) {
        log.date = date;
        log.product = product;
        log.revenue = rev;
      }
    } else {
      salesLogs.push({ id: Date.now(), seller: currentTarget, product, date, revenue: rev });
    }

    salesLogs.sort((a, b) => (b.date || '').localeCompare(a.date || ''));

    editingLogId = null;
    saveToLocal();
    resetLogFields();
    renderModalItemsPeriod();
    renderLogHistoryPeriod();
    renderAll();
  }

  function deleteLog(id) {
    if (!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    salesLogs = salesLogs.filter(l => l.id !== id);
    if (editingLogId === id) { editingLogId = null; resetLogFields(); }
    saveToLocal();
    renderModalItemsPeriod();
    renderLogHistoryPeriod();
    renderAll();
  }

  // -------------------------
  // Product modal
  // -------------------------
  function openProductModal(productName) {
    currentProductTarget = productName;
    document.getElementById('productModalTitle').innerText = productName;
    document.getElementById('productModal').classList.remove('hidden');

    const { label } = getPeriod();
    document.getElementById('productModalSubtitle').innerText = (label === 'ì „ì²´') ? 'ì „ì²´ ê¸°ê°„ ì§‘ê³„' : `${label} ì§‘ê³„`;

    const logs = filterLogsByPeriod(salesLogs.filter(l => l.product === productName));
    const sellerAgg = {};
    logs.forEach(l => { sellerAgg[l.seller] = (sellerAgg[l.seller] || 0) + Number(l.revenue || 0); });
    const sorted = Object.entries(sellerAgg).sort((a, b) => b[1] - a[1]);

    const total = sorted.reduce((s, [, v]) => s + v, 0);
    document.getElementById('productSellerTotal').innerText = `ì´ ${total.toFixed(2)}ì–µì›`;

    const list = document.getElementById('productSellerList');
    list.innerHTML = "";
    if (!sorted.length) {
      list.innerHTML = "<div class='text-center py-10 text-slate-300 font-black uppercase'>No Data</div>";
      return;
    }

    sorted.forEach(([seller, rev], idx) => {
      const percent = total > 0 ? (rev / total * 100).toFixed(1) : '0.0';
      const row = document.createElement('div');
      row.className = "flex items-center gap-3 p-3 rounded-xl border border-slate-100 hover:bg-slate-50 transition-all cursor-pointer";
      row.onclick = () => { closeProductModal(); openSellerModal(seller); };
      row.innerHTML = `
        <div class="w-6 h-6 flex items-center justify-center bg-emerald-600 rounded-full text-[9px] font-black text-white">${idx + 1}</div>
        <div class="flex-1">
          <div class="flex justify-between items-center mb-1">
            <span class="text-xs font-bold text-slate-700">${escapeHtml(seller)}</span>
            <span class="text-xs font-bold text-emerald-600">${rev.toFixed(2)}ì–µ</span>
          </div>
          <div class="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden">
            <div class="bg-emerald-500 h-full" style="width: ${percent}%;"></div>
          </div>
        </div>
        <div class="text-[10px] font-black text-slate-400 w-10 text-right">${percent}%</div>
      `;
      list.appendChild(row);
    });
  }

  function closeProductModal() {
    document.getElementById('productModal').classList.add('hidden');
    currentProductTarget = '';
  }

  // -------------------------
  // Excel export / import
  // -------------------------
  function yymmddLocal() {
    const d = new Date();
    const yy = String(d.getFullYear()).slice(2);
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${yy}${mm}${dd}`;
  }

  function exportToExcel() {
    const wb = XLSX.utils.book_new();
    const rows = [];
    salesLogs.forEach(l => {
      rows.push({ 'ì…€ëŸ¬ëª…': l.seller, 'ìƒí’ˆëª…': l.product, 'í–‰ì‚¬ì¼': l.date, 'ë§¤ì¶œì•¡(ì–µì›)': l.revenue });
    });
    rawData.forEach(s => {
      (s.products || []).forEach(p => {
        if (!rows.some(r => r['ì…€ëŸ¬ëª…'] === s.name && r['ìƒí’ˆëª…'] === p)) {
          rows.push({ 'ì…€ëŸ¬ëª…': s.name, 'ìƒí’ˆëª…': p, 'í–‰ì‚¬ì¼': '', 'ë§¤ì¶œì•¡(ì–µì›)': '' });
        }
      });
      if (!(s.products || []).length && !rows.some(r => r['ì…€ëŸ¬ëª…'] === s.name)) {
        rows.push({ 'ì…€ëŸ¬ëª…': s.name, 'ìƒí’ˆëª…': '', 'í–‰ì‚¬ì¼': '', 'ë§¤ì¶œì•¡(ì–µì›)': '' });
      }
    });
    rows.sort((a, b) => koreanSort(a['ì…€ëŸ¬ëª…'], b['ì…€ëŸ¬ëª…']) || koreanSort(a['ìƒí’ˆëª…'], b['ìƒí’ˆëª…']));
    const ws = XLSX.utils.json_to_sheet(rows, { header: ['ì…€ëŸ¬ëª…', 'ìƒí’ˆëª…', 'í–‰ì‚¬ì¼', 'ë§¤ì¶œì•¡(ì–µì›)'] });
    XLSX.utils.book_append_sheet(wb, ws, 'Data');
    XLSX.writeFile(wb, `seller_dashboard_${yymmddLocal()}.xlsx`);
  }

  function triggerImport() { document.getElementById('importFile').click(); }

  function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });

        const sellerMap = new Map();
        const newLogs = [];

        json.forEach((row, index) => {
          const seller = String(row["ì…€ëŸ¬ëª…"] || row["ì…€ëŸ¬"] || row["Seller"] || row["seller"] || "").trim();
          if (!seller) return;

          if (!sellerMap.has(seller)) sellerMap.set(seller, { name: seller, products: [] });

          const product = String(row["ìƒí’ˆëª…"] || row["ìƒí’ˆ"] || row["Product"] || row["product"] || "").trim();
          if (product) {
            const s = sellerMap.get(seller);
            if (!s.products.includes(product)) s.products.push(product);
          }

          let date = row["í–‰ì‚¬ì¼"] || row["ì¼ì •"] || row["ë‚ ì§œ"] || row["Date"] || row["date"] || "";
          if (date instanceof Date) date = date.toISOString().split('T')[0];
          else date = String(date).trim().slice(0, 10);

          let revenue = row["ë§¤ì¶œì•¡(ì–µì›)"] ?? row["ë§¤ì¶œì•¡"] ?? row["ë§¤ì¶œ"] ?? row["Revenue"] ?? row["revenue"] ?? "";
          const parsed = Number(String(revenue).replace(/,/g, ""));
          const rev = isNaN(parsed) ? null : parsed;

          if (product && (date || rev !== null)) {
            newLogs.push({
              id: Date.now() + index,
              seller,
              product,
              date: date || "",
              revenue: rev !== null ? rev : 0
            });
          }
        });

        rawData = Array.from(sellerMap.values()).map(s => ({ name: s.name, products: uniqueSorted(s.products) }))
          .sort((a,b)=>koreanSort(a.name,b.name));
        salesLogs = newLogs.slice().sort((a,b) => (b.date||'').localeCompare(a.date||''));

        saveToLocal();
        alert(`ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!\në“±ë¡ëœ ì…€ëŸ¬: ${rawData.length}ëª…\nê¸°ë¡: ${salesLogs.length}ê±´`);
        location.reload();
      } catch (err) {
        console.error(err);
        alert("íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function clearAllData() {
    if (!confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    localStorage.removeItem('sorted_rawData');
    localStorage.removeItem('sorted_salesLogs');
    location.reload();
  }

  // -------------------------
  // Print (Calendar)
  // -------------------------
  function openCalendarPrintModal() {
    // ìº˜ë¦°ë” ë·°ê°€ ì•„ë‹ˆì–´ë„ í”„ë¦°íŠ¸ëŠ” ìº˜ë¦°ë” ê¸°ì¤€ìœ¼ë¡œ ë™ì‘
    document.getElementById('calendarPrintModal').classList.remove('hidden');
    syncPrintOriButtons();
  }

  function closeCalendarPrintModal() {
    document.getElementById('calendarPrintModal').classList.add('hidden');
  }

  function setCalendarPrintOrientation(ori) {
    calendarPrintOrientation = ori;
    syncPrintOriButtons();
  }

  function syncPrintOriButtons() {
    const p = document.getElementById('printOriPortrait');
    const l = document.getElementById('printOriLandscape');
    if (!p || !l) return;

    if (calendarPrintOrientation === 'portrait') {
      p.classList.add('border-blue-600','bg-blue-50','text-blue-700');
      p.classList.remove('border-slate-200','text-slate-600');
      l.classList.remove('border-blue-600','bg-blue-50','text-blue-700');
      l.classList.add('border-slate-200','text-slate-600');
    } else {
      l.classList.add('border-blue-600','bg-blue-50','text-blue-700');
      l.classList.remove('border-slate-200','text-slate-600');
      p.classList.remove('border-blue-600','bg-blue-50','text-blue-700');
      p.classList.add('border-slate-200','text-slate-600');
    }
  }

  async function executeCalendarPrint() {
    closeCalendarPrintModal();

    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.classList.add('active');

    // ìº˜ë¦°ë”ê°€ ë‹¤ë¥¸ ë·°ì— ìˆì–´ë„ ìº¡ì²˜ëŠ” í•´ì•¼ í•˜ë¯€ë¡œ ì ê¹ ìº˜ë¦°ë” ë Œë” ìƒíƒœ í™•ë³´
    const calendarView = document.getElementById('calendarView');
    const wasHidden = calendarView.classList.contains('hidden');
    const prevView = currentView;

    if (prevView !== 'calendar') {
      // ìº˜ë¦°ë”ë¡œ ì „í™˜í•´ì„œ ë Œë” í™•ì‹¤íˆ
      switchView('calendar');
      await new Promise(r => setTimeout(r, 60));
    }

    // âœ… í”„ë¦°íŠ¸ ì „ ë ˆì´ì•„ì›ƒ ê¸°ì¤€ìœ¼ë¡œ ì´ë²¤íŠ¸ ê°œìˆ˜ ì¬ê³„ì‚°(í•„ìˆ˜)
    await new Promise(r => requestAnimationFrame(r));
    renderCalendarEvents();
    await new Promise(r => setTimeout(r, 80));

    // âœ… ìº¡ì²˜ìš© í´ë˜ìŠ¤ ì¶”ê°€ (í•œê¸€ í°íŠ¸ ë³´ì •)
    const calendarGridEl = document.getElementById('calendarGrid');
    calendarGridEl.classList.add('print-capture-mode');
    await new Promise(r => setTimeout(r, 50));  // CSS ì ìš© ëŒ€ê¸°

    // print style(@page)
    let printStyle = document.getElementById('calendarPrintPageStyle');
    if (printStyle) printStyle.remove();
    printStyle = document.createElement('style');
    printStyle.id = 'calendarPrintPageStyle';
    printStyle.textContent = `@media print { @page { size: A4 ${calendarPrintOrientation}; margin: 6mm; } }`;
    document.head.appendChild(printStyle);

    try {
      const canvas = await html2canvas(calendarGridEl, {
        scale: 2,
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff',
        scrollX: 0,
        scrollY: -window.scrollY
      });

      const printContainer = document.getElementById('calendarPrintContainer');
      printContainer.innerHTML = '';

      const img = document.createElement('img');
      img.src = canvas.toDataURL('image/png');
      img.style.maxWidth = '100%';
      img.style.maxHeight = '100%';
      img.style.width = 'auto';
      img.style.height = 'auto';
      img.style.objectFit = 'contain';
      printContainer.appendChild(img);

      loadingOverlay.classList.remove('active');

      setTimeout(() => {
        window.print();
      }, 100);

    } catch (err) {
      console.error('[CalendarPrint] error:', err);
      loadingOverlay.classList.remove('active');
      alert('ì¸ì‡„ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      // âœ… ìº¡ì²˜ìš© í´ë˜ìŠ¤ ì œê±°
      document.getElementById('calendarGrid')?.classList.remove('print-capture-mode');
      
      // ìº˜ë¦°ë”ë¡œ ê°•ì œ ì „í™˜í–ˆìœ¼ë©´ ì›ìƒ ë³µêµ¬
      if (prevView !== 'calendar') {
        switchView(prevView);
      } else if (wasHidden) {
        calendarView.classList.add('hidden');
      }
    }
  }

  // -------------------------
  // Help Popup
  // -------------------------
  function openHelpPopup() {
    // ì´ë¯¸ ì—´ë ¤ ìˆìœ¼ë©´ ìƒˆë¡œ ì—´ì§€ ë§ê³  í¬ì»¤ìŠ¤ë§Œ ì´ë™í•©ë‹ˆë‹¤.
    if (helpPopupWin && !helpPopupWin.closed) {
      helpPopupWin.focus();
      return;
    }

    const w = Math.min(980, window.screen.width - 40);
    const h = Math.min(760, window.screen.height - 80);
    const left = Math.max(0, Math.round((window.screen.width - w) / 2));
    const top = Math.max(0, Math.round((window.screen.height - h) / 2));

    // âœ… noopener/noreferrer ê°™ì€ ì˜µì…˜ì€ ë¸Œë¼ìš°ì €ë³„ë¡œ ë°˜í™˜ê°’ null ì´ìŠˆë¥¼ ë§Œë“¤ ìˆ˜ ìˆì–´ ì œê±°í•©ë‹ˆë‹¤.
    const features = [
      `width=${w}`,
      `height=${h}`,
      `left=${left}`,
      `top=${top}`,
      'resizable=yes',
      'scrollbars=yes'
    ].join(',');

    helpPopupWin = window.open('help.html', 'SellerDashboardHelp', features);

    // âœ… ë¸Œë¼ìš°ì €ì— ë”°ë¼ ì¦‰ì‹œ nullì„ ì£¼ëŠ” ê²½ìš°ê°€ ìˆì–´,
    //    ì§§ê²Œ ê¸°ë‹¤ë ¸ë‹¤ê°€ "ì§„ì§œ ì°¨ë‹¨"ì¸ ê²½ìš°ì—ë§Œ ì•ˆë‚´í•©ë‹ˆë‹¤.
    setTimeout(() => {
      if (!helpPopupWin || helpPopupWin.closed) {
        helpPopupWin = null;
        alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € íŒì—… ì°¨ë‹¨ì„ í•´ì œí•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì‹­ì‹œì˜¤.');
        return;
      }
      // ë³´ì•ˆ ëª©ì (ê°€ëŠ¥í•œ ê²½ìš°): opener ëŠê¸°
      try { helpPopupWin.opener = null; } catch (e) {}
      helpPopupWin.focus();
    }, 150);
  }


  // -------------------------
  // Misc
  // -------------------------
  function escapeHtml(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function onPeriodDropdownChange() {
    const y = document.getElementById('filterYear').value;
    const m = document.getElementById('filterMonth').value;
    if (y && m) pendingJumpToTodayOnNav = false;
    syncCalendarStateFromHeader();
    closeSelectedDateEvents();
    renderAll();
  }

  // -------------------------
  // Event wiring
  // -------------------------
  let resizeTimer = null;
  window.onload = () => {
    loadFromLocal();
    renderAll();

    document.getElementById('filterYear').addEventListener('change', onPeriodDropdownChange);
    document.getElementById('filterMonth').addEventListener('change', onPeriodDropdownChange);

    window.addEventListener('resize', () => {
      if (resizeTimer) clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (currentView === 'calendar') {
          renderCalendarEvents();
        }
      }, 100);
    });
  };

  window.onclick = (e) => {
    const modal = document.getElementById('modal');
    const pmodal = document.getElementById('productModal');
    const newEntryModal = document.getElementById('newEntryModal');
    const printModal = document.getElementById('calendarPrintModal');

    if (e.target === modal) closeModal();
    if (e.target === pmodal) closeProductModal();
    if (e.target === newEntryModal) closeNewEntryModal();
    if (e.target === printModal) closeCalendarPrintModal();
  };
</script>

</body>
</html>
