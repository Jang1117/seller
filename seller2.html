<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Dashboard Pro</title>

    <!-- SheetJS ë° Tailwind CSS -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }

        /* í™œì„±í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .active-view-btn { background-color: #2563eb !important; color: white !important; }
        .active-filter-btn { background-color: #2563eb !important; color: white !important; }
        .active-tab { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 900; }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        .card-animate { animation: fadeInUp 0.3s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }

        /* ë¡œê·¸ ì„ íƒ ê°•ì¡°(í† ê¸€) */
        .selected-log-item {
            border: 2px solid #2563eb !important;
            background-color: #eff6ff !important;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        /* ë¹ˆ ìƒíƒœ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .empty-state-card {
            border: 2px dashed #cbd5e1;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        .empty-state-card:hover {
            border-color: #2563eb;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

    <!-- í—¤ë” ì˜ì—­ -->
    <header class="bg-white border-b shadow-sm z-30 px-8 py-4 flex flex-col lg:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-3 flex-wrap">
            <div class="flex items-center mr-2">
                <img src="data:image/jpeg;base64,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" alt="Linkers" class="h-7 md:h-8 w-auto" />
            </div>

            <!-- ê¸°ê°„ í•„í„° -->
            <div class="flex bg-white p-1 rounded-xl border border-slate-200 shadow-sm items-center gap-1">
                <button id="viewAllBtn" onclick="resetGlobalFilter()" class="px-4 py-2 text-xs font-bold rounded-lg text-slate-500 hover:bg-slate-50 transition-all">ì „ì²´ ê¸°ê°„</button>
                <div class="w-px h-4 bg-slate-200 mx-1"></div>
                <select id="filterYear" class="px-3 py-2 text-xs font-bold rounded-lg text-slate-500 bg-slate-50 border border-slate-200 outline-none">
                    <option value="">ì—°ë„</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026" selected>2026</option>
                </select>
                <select id="filterMonth" class="px-3 py-2 text-xs font-bold rounded-lg text-slate-500 bg-slate-50 border border-slate-200 outline-none">
                    <option value="">ì›”</option>
                    <option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option>
                    <option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option>
                    <option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
                </select>
            </div>

            <!-- ë·° ì „í™˜ -->
            <div class="flex bg-white p-1 rounded-xl border border-slate-200 shadow-sm items-center gap-1">
                <button id="viewSellerBtn" onclick="switchView('seller')" class="px-4 py-2 text-xs font-bold rounded-lg active-view-btn">ì…€ëŸ¬</button>
                <button id="viewProductBtn" onclick="switchView('product')" class="px-4 py-2 text-xs font-bold rounded-lg text-slate-500 hover:bg-slate-50 transition-all">ìƒí’ˆ</button>
                <button id="viewStatsBtn" onclick="switchView('stats')" class="px-4 py-2 text-xs font-bold rounded-lg text-slate-500 hover:bg-slate-50 transition-all">ìš”ì•½</button>
            </div>

            <!-- ì…€ëŸ¬ í•„í„° (ìƒí’ˆ ìˆìŒ/ì—†ìŒ: í•´ë‹¹ ê¸°ê°„ ë¡œê·¸ ê¸°ì¤€) -->
            <div id="sellerFilterGroup" class="flex bg-slate-100 p-1 rounded-xl border border-slate-200 shadow-sm">
                <button onclick="setSellerFilter('all')" id="filterAll" class="px-3 py-2 text-[11px] font-bold rounded-lg active-filter-btn text-white">ì „ì²´</button>
                <button onclick="setSellerFilter('hasProduct')" id="filterHas" class="px-3 py-2 text-[11px] font-bold rounded-lg text-slate-500">ìƒí’ˆ ìˆìŒ</button>
                <button onclick="setSellerFilter('noProduct')" id="filterNo" class="px-3 py-2 text-[11px] font-bold rounded-lg text-slate-500">ìƒí’ˆ ì—†ìŒ</button>
            </div>

            <!-- ì‹ ê·œ ì¶”ê°€ ë²„íŠ¼ -->
            <button onclick="openNewEntryModal()" class="flex items-center gap-1.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:from-blue-700 hover:to-indigo-700 transition-all shadow-md hover:shadow-lg">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                ì‹ ê·œ ì¶”ê°€
            </button>
        </div>

        <!-- ê²€ìƒ‰ ë° ë°ì´í„° ê´€ë¦¬ -->
        <div class="flex items-center gap-2">
            <div id="searchArea" class="relative w-40">
                <input type="text" id="globalSearch" oninput="renderAll()" placeholder="ê²€ìƒ‰."
                       class="w-full pl-8 pr-4 py-2 bg-slate-50 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500">
                <svg class="w-3.5 h-3.5 text-slate-400 absolute left-2.5 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-3 py-2 rounded-xl text-[11px] font-bold hover:bg-emerald-700 transition-all">ì €ì¥</button>
            <button onclick="triggerImport()" class="bg-slate-700 text-white px-3 py-2 rounded-xl text-[11px] font-bold hover:bg-slate-800 transition-all">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button id="excelBackupBtn" onclick="setupExcelAutoBackup()" class="bg-blue-50 text-blue-700 border border-blue-100 px-3 py-2 rounded-xl text-[11px] font-bold hover:bg-blue-100 transition-all" title="Chrome/Edgeì—ì„œ í´ë”ë¥¼ ì„ íƒí•˜ë©´ ì´í›„ ìë™ìœ¼ë¡œ ê°™ì€ ì´ë¦„ìœ¼ë¡œ ë®ì–´ì¨ ì €ì¥ë©ë‹ˆë‹¤.">ì—‘ì…€ ìë™ë°±ì—…</button>
            <button onclick="clearAllData()" class="bg-red-50 text-red-600 border border-red-100 px-3 py-2 rounded-xl text-[11px] font-bold hover:bg-red-100">ì´ˆê¸°í™”</button>
            <input type="file" id="importFile" class="hidden" accept=".xlsx, .xls, .csv" onchange="importData(event)">
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="flex-1 overflow-y-auto p-8 custom-scrollbar">
        <div class="max-w-[1500px] mx-auto">
            <!-- ê·¸ë¦¬ë“œ ë·° (ì…€ëŸ¬/ìƒí’ˆ) -->
            <div id="mainGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6"></div>

            <!-- ì›”ë³„ ìš”ì•½ ë·° (í†µê³„) -->
            <div id="statsView" class="hidden space-y-8 animate-in fade-in duration-500">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <div>
                        <h2 class="text-2xl font-black text-slate-800 tracking-tight">ì›”ë³„ ë§¤ì¶œ ìš”ì•½ ë¦¬í¬íŠ¸</h2>
                        <p id="statsDisplayTitle" class="text-blue-600 font-bold uppercase text-sm mt-1"></p>
                    </div>

                    <!-- stats mode toggle -->
                    <div class="flex bg-slate-100 p-1 rounded-xl border border-slate-200 shadow-sm">
                        <button id="statsModeSeller" onclick="setStatsMode('seller')" class="px-3 py-2 text-[11px] font-bold rounded-lg active-filter-btn text-white">ì…€ëŸ¬ ê¸°ì¤€</button>
                        <button id="statsModeProduct" onclick="setStatsMode('product')" class="px-3 py-2 text-[11px] font-bold rounded-lg text-slate-500">ìƒí’ˆ ê¸°ì¤€</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-1 bg-blue-600 p-8 rounded-[2.5rem] shadow-xl text-white flex flex-col justify-center">
                        <p class="text-blue-100 text-xs font-black uppercase mb-2">Total Revenue</p>
                        <h3 id="totalMonthRevenue" class="text-5xl font-black">0.00 <span class="text-xl font-bold">ì–µì›</span></h3>
                    </div>
                    <div class="md:col-span-2 bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 pr-2">
                        <div id="statsTableContainer" class="space-y-4 max-h-[500px] overflow-y-auto custom-scrollbar"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- í‘¸í„° -->
    <footer class="bg-white border-t py-4 px-8 text-center md:flex md:justify-between items-center z-30">
        <p class="text-slate-400 text-xs font-medium">Â© 2026 <span class="font-black text-slate-600 uppercase">Jang</span>. All rights reserved.</p>
        <p class="text-slate-400 text-xs font-medium mt-1 md:mt-0">Seller Management System</p>
    </footer>

    <!-- ì‹ ê·œ ë°ì´í„° ì…ë ¥ ëª¨ë‹¬ -->
    <div id="newEntryModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in duration-150">
            <div class="p-8 border-b bg-gradient-to-r from-blue-600 to-indigo-600 relative">
                <h2 class="text-2xl font-black text-white tracking-tight">ì‹ ê·œ ë°ì´í„° ì¶”ê°€</h2>
                <p class="text-blue-100 text-sm mt-1">ì…€ëŸ¬ì™€ ìƒí’ˆ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                <button onclick="closeNewEntryModal()" class="absolute top-8 right-8 text-white/70 hover:text-white font-bold text-2xl transition-colors">Ã—</button>
            </div>
            <div class="p-8 space-y-5">
                <!-- ì…€ëŸ¬ëª… (í•„ìˆ˜) -->
                <div class="flex flex-col gap-2">
                    <label class="text-[11px] font-black text-slate-500 uppercase tracking-wider flex items-center gap-1">
                        ì…€ëŸ¬ëª… 
                        <span class="text-red-500">*</span>
                        <span class="text-slate-400 font-normal normal-case">(í•„ìˆ˜)</span>
                    </label>
                    <div class="relative">
                        <input type="text" id="newSellerName" list="existingSellersList"
                               class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all"
                               placeholder="ì…€ëŸ¬ëª… ì…ë ¥ ë˜ëŠ” ì„ íƒ">
                        <datalist id="existingSellersList"></datalist>
                    </div>
                </div>

                <!-- ìƒí’ˆëª… (ì„ íƒ) -->
                <div class="flex flex-col gap-2">
                    <label class="text-[11px] font-black text-slate-500 uppercase tracking-wider flex items-center gap-1">
                        ìƒí’ˆëª…
                        <span class="text-slate-400 font-normal normal-case">(ì„ íƒ)</span>
                    </label>
                    <div class="relative">
                        <input type="text" id="newProductName" list="existingProductsList"
                               class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all"
                               placeholder="ìƒí’ˆëª… ì…ë ¥ ë˜ëŠ” ì„ íƒ">
                        <datalist id="existingProductsList"></datalist>
                    </div>
                </div>

                <!-- í–‰ì‚¬ì¼ (ì„ íƒ) -->
                <div class="flex flex-col gap-2">
                    <label class="text-[11px] font-black text-slate-500 uppercase tracking-wider flex items-center gap-1">
                        í–‰ì‚¬ì¼
                        <span class="text-slate-400 font-normal normal-case">(ì„ íƒ)</span>
                    </label>
                    <input type="date" id="newEventDate"
                           class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all">
                </div>

                <!-- ë§¤ì¶œì•¡ (ì„ íƒ) -->
                <div class="flex flex-col gap-2">
                    <label class="text-[11px] font-black text-slate-500 uppercase tracking-wider flex items-center gap-1">
                        ë§¤ì¶œì•¡
                        <span class="text-slate-400 font-normal normal-case">(ì„ íƒ, ì–µì› ë‹¨ìœ„)</span>
                    </label>
                    <input type="number" id="newRevenue" step="0.01" min="0"
                           class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all"
                           placeholder="0.00">
                </div>

                <!-- ë²„íŠ¼ ì˜ì—­ -->
                <div class="flex gap-3 pt-4">
                    <button onclick="closeNewEntryModal()" 
                            class="flex-1 py-3 px-4 border-2 border-slate-200 text-slate-600 rounded-xl text-sm font-bold hover:bg-slate-50 transition-all">
                        ì·¨ì†Œ
                    </button>
                    <button onclick="submitNewEntry()" 
                            class="flex-1 py-3 px-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl text-sm font-bold hover:from-blue-700 hover:to-indigo-700 transition-all shadow-md hover:shadow-lg">
                        ì¶”ê°€í•˜ê¸°
                    </button>
                </div>

                <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
                <div class="bg-slate-50 border border-slate-100 rounded-xl p-4 mt-2">
                    <p class="text-[11px] text-slate-500 leading-relaxed">
                        <span class="font-bold text-slate-600">ğŸ’¡ TIP:</span> 
                        ì…€ëŸ¬ëª…ë§Œ ì…ë ¥í•´ë„ ë“±ë¡ë©ë‹ˆë‹¤. ìƒí’ˆ/í–‰ì‚¬ì¼/ë§¤ì¶œì€ ë‚˜ì¤‘ì— ì…€ëŸ¬ ì¹´ë“œë¥¼ í´ë¦­í•´ì„œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ íŒì—… (ì…€ëŸ¬) -->
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-lg overflow-hidden animate-in zoom-in duration-150">
            <div class="p-8 border-b bg-slate-50 relative">
                <h2 id="modalTitle" class="text-2xl font-black text-slate-800 tracking-tight uppercase leading-none text-blue-600">ê´€ë¦¬</h2>
                <button onclick="closeModal()" class="absolute top-8 right-8 text-slate-400 hover:text-slate-600 font-bold text-2xl">Ã—</button>
                <div class="flex gap-6 mt-6">
                    <button id="tabRel" onclick="switchTab('rel')" class="pb-2 text-sm font-bold active-tab transition-all">í–‰ì‚¬ ìƒí’ˆ</button>
                    <button id="tabLog" onclick="switchTab('log')" class="pb-2 text-sm font-bold text-slate-400 transition-all">ì¼ì •/ë§¤ì¶œ ê¸°ë¡</button>
                </div>
            </div>
            <div class="p-8">
                <!-- íƒ­ 1: í–‰ì‚¬ ìƒí’ˆ ëª©ë¡ (í•´ë‹¹ ê¸°ê°„ ë¡œê·¸ ê¸°ì¤€) -->
                <div id="tabContentRel" class="space-y-6">
                    <div id="modalItemList" class="flex flex-wrap gap-2 max-h-56 overflow-y-auto custom-scrollbar pr-1"></div>
                </div>

                <!-- íƒ­ 2: ì¼ì •/ë§¤ì¶œ ê¸°ë¡ (ì‹ ê·œ ì…ë ¥ì€ í•­ìƒ ë§ˆìŠ¤í„° ìƒí’ˆ ì„ íƒ ê°€ëŠ¥) -->
                <div id="tabContentLog" class="hidden space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">í–‰ì‚¬ì¼</label>
                            <input type="date" id="logDate" class="w-full px-3 py-2 border rounded-lg text-sm outline-none">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">ìƒí’ˆëª…</label>
                            <select id="logProduct" class="w-full px-3 py-2 border rounded-lg text-sm outline-none"></select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">ë§¤ì¶œì•¡(ì–µì›)</label>
                            <input type="number" id="logRevenue" step="0.01" class="w-full px-3 py-2 border rounded-lg text-sm outline-none" placeholder="0.00">
                        </div>
                    </div>
                    <button id="submitLogBtn" onclick="submitLog()" class="w-full bg-blue-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-blue-700 shadow-sm">ê¸°ë¡ ì¶”ê°€/ìˆ˜ì •</button>
                    <div id="logHistoryList" class="space-y-2 max-h-56 overflow-y-auto custom-scrollbar pr-1 pt-2"></div>
                    <div class="text-[11px] text-slate-400 font-bold">
                        * ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ í•­ëª© í´ë¦­: ì„ íƒ(íŒŒë€ í…Œë‘ë¦¬) / ë‹¤ì‹œ í´ë¦­: ì„ íƒ í•´ì œ + ì…ë ¥ ì´ˆê¸°í™”
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒí’ˆ ë¶„ì„ ëª¨ë‹¬ (ìƒí’ˆ ê¸°ì¤€ íŒì—…: ì…€ëŸ¬ë³„ ë§¤ì¶œë§Œ) -->
    <div id="productModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-2xl overflow-hidden animate-in zoom-in duration-150">
            <div class="p-8 border-b bg-slate-50 relative">
                <h2 id="productModalTitle" class="text-2xl font-black text-slate-800 tracking-tight uppercase leading-none text-emerald-600">ìƒí’ˆ ë¶„ì„</h2>
                <button onclick="closeProductModal()" class="absolute top-8 right-8 text-slate-400 hover:text-slate-600 font-bold text-2xl">Ã—</button>
                <p id="productModalSubtitle" class="mt-3 text-xs font-bold text-slate-400 uppercase tracking-wider"></p>
            </div>
            <div class="p-8 space-y-6">
                <div class="bg-white p-6 rounded-[1.8rem] border border-slate-200 shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-black text-slate-800 uppercase tracking-tight">ì…€ëŸ¬ë³„ ë§¤ì¶œ</h3>
                        <span id="productSellerTotal" class="text-xs font-black text-emerald-600"></span>
                    </div>
                    <div id="productSellerList" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar pr-1"></div>
                </div>
                <div class="bg-slate-50 border border-slate-100 rounded-[1.8rem] p-5">
                    <p class="text-[11px] font-bold text-slate-500 leading-relaxed">
                        * í˜„ì¬ ìƒë‹¨ ê¸°ê°„ í•„í„°(ì—°/ì›”)ì— ë§ì¶° ì§‘ê³„ë©ë‹ˆë‹¤. (ì›” ì„ íƒ ì‹œ: í•´ë‹¹ ì›” / ì—°ë„ë§Œ ì„ íƒ ì‹œ: í•´ë‹¹ ì—°ë„ / ë¯¸ì„ íƒ: ì „ì²´)
                    </p>
                </div>
            </div>
        </div>
    </div>

<script>
    // -------------------------
    // State
    // -------------------------
    let rawData = [];
    let salesLogs = [];
    let currentView = 'seller';
    let sellerFilter = 'all';
    let statsMode = 'seller';

    let currentTarget = '';     // seller modal
    let editingLogId = null;    // selected log id (toggle)

    let currentProductTarget = ''; // product modal

    const koreanSort = (a, b) => (a || '').localeCompare((b || ''), 'ko');

    // -------------------------
// Storage + Auto Backup (Daily, overwrite same-day)
// -------------------------
const AUTO_BACKUP_PREFIX = 'sorted_auto_backup_';
let autoBackupTimer = null;

function yymmddLocal() {
    const d = new Date();
    const yy = String(d.getFullYear()).slice(2);
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${yy}${mm}${dd}`; // e.g. 260109
}

function runAutoBackupNow() {
    try {
        const stamp = yymmddLocal();
        const key = AUTO_BACKUP_PREFIX + stamp; // file-name-like key ends with _YYMMDD
        const payload = {
            version: 1,
            stamp,                  // 'YYMMDD'
            createdAt: new Date().toISOString(),
            rawData,
            salesLogs
        };

        // Overwrite same-day backup silently (no prompt)
        localStorage.setItem(key, JSON.stringify(payload));

        // Maintain an index (optional) and prune old backups to avoid unlimited growth
        const indexKey = AUTO_BACKUP_PREFIX + 'index';
        let index = [];
        try { index = JSON.parse(localStorage.getItem(indexKey) || '[]'); } catch (_) { index = []; }
        if (!Array.isArray(index)) index = [];

        // Keep only valid keys
        index = index.filter(k => typeof k === 'string' && k.startsWith(AUTO_BACKUP_PREFIX) && k.length === AUTO_BACKUP_PREFIX.length + 6);

        if (!index.includes(key)) index.push(key);
        index.sort(); // chronological by yymmdd suffix

        const KEEP_DAYS = 90; // keep last N daily backups
        if (index.length > KEEP_DAYS) {
            const remove = index.slice(0, index.length - KEEP_DAYS);
            remove.forEach(k => localStorage.removeItem(k));
            index = index.slice(-KEEP_DAYS);
        }
        localStorage.setItem(indexKey, JSON.stringify(index));
    } catch (e) {
        console.warn('[AutoBackup] failed:', e);
    }
}

function scheduleAutoBackup() {
    // debounce to prevent too many writes when editing quickly
    if (autoBackupTimer) clearTimeout(autoBackupTimer);
    autoBackupTimer = setTimeout(runAutoBackupNow, 600);
}


// ===== Excel Auto Backup (File System Access API; Chrome/Edge) =====
let excelBackupTimer = null;
let excelBackupDirHandle = null;
let excelBackupEnabled = false;
const EXCEL_BACKUP_DB = 'st_excel_backup_db_v1';
const EXCEL_BACKUP_STORE = 'kv';
const EXCEL_BACKUP_HANDLE_KEY = 'excel_backup_dir_handle';
const EXCEL_BACKUP_ENABLED_KEY = 'excel_backup_enabled';

// Minimal IndexedDB KV helpers (to persist DirectoryHandle)
function idbOpen() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open(EXCEL_BACKUP_DB, 1);
        req.onupgradeneeded = () => {
            const db = req.result;
            if (!db.objectStoreNames.contains(EXCEL_BACKUP_STORE)) db.createObjectStore(EXCEL_BACKUP_STORE);
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
    });
}
async function idbGet(key) {
    const db = await idbOpen();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(EXCEL_BACKUP_STORE, 'readonly');
        const store = tx.objectStore(EXCEL_BACKUP_STORE);
        const req = store.get(key);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
        tx.oncomplete = () => db.close();
    });
}
async function idbSet(key, value) {
    const db = await idbOpen();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(EXCEL_BACKUP_STORE, 'readwrite');
        const store = tx.objectStore(EXCEL_BACKUP_STORE);
        const req = store.put(value, key);
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error);
        tx.oncomplete = () => db.close();
    });
}

function updateExcelBackupBtnUI() {
    const btn = document.getElementById('excelBackupBtn');
    if (!btn) return;
    if (!window.showDirectoryPicker) {
        btn.innerText = 'ì—‘ì…€ ìë™ë°±ì—…(ë¶ˆê°€)';
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        return;
    }
    if (excelBackupEnabled && excelBackupDirHandle) {
        btn.innerText = 'ì—‘ì…€ ìë™ë°±ì—…: ON';
        btn.classList.remove('bg-blue-50', 'text-blue-700', 'border-blue-100');
        btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
    } else {
        btn.innerText = 'ì—‘ì…€ ìë™ë°±ì—…';
        btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
        btn.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-100');
    }
}

async function setupExcelAutoBackup() {
    if (!window.showDirectoryPicker) {
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” í´ë” ì„ íƒ ê¸°ë°˜ ìë™ ë®ì–´ì“°ê¸° ì €ì¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome/Edge ê¶Œì¥)');
        return;
    }
    try {
        const dir = await window.showDirectoryPicker({ mode: 'readwrite' });
        const perm = await dir.requestPermission({ mode: 'readwrite' });
        if (perm !== 'granted') {
            alert('í´ë” ì“°ê¸° ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }
        excelBackupDirHandle = dir;
        excelBackupEnabled = true;
        localStorage.setItem(EXCEL_BACKUP_ENABLED_KEY, '1');
        await idbSet(EXCEL_BACKUP_HANDLE_KEY, dir);

        updateExcelBackupBtnUI();
        // immediately create/update today's backup once
        scheduleExcelBackup();
        alert('ì—‘ì…€ ìë™ë°±ì—…ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë°ì´í„°ê°€ ë°”ë€” ë•Œë§ˆë‹¤ ì„ íƒí•œ í´ë”ì— í•˜ë£¨ 1ê°œ íŒŒì¼ë¡œ ìë™ ë®ì–´ì¨ ì €ì¥ë©ë‹ˆë‹¤.');
    } catch (e) {
        // user cancel is normal
        if (String(e?.name || '').includes('Abort')) return;
        console.warn('[ExcelAutoBackup] setup failed:', e);
        alert('ì—‘ì…€ ìë™ë°±ì—… ì„¤ì • ì‹¤íŒ¨: ' + (e?.message || e));
    }
}

async function loadExcelAutoBackupSetting() {
    try {
        excelBackupEnabled = localStorage.getItem(EXCEL_BACKUP_ENABLED_KEY) === '1';
        if (!excelBackupEnabled) {
            updateExcelBackupBtnUI();
            return;
        }
        if (!window.showDirectoryPicker) {
            excelBackupEnabled = false;
            updateExcelBackupBtnUI();
            return;
        }
        const dir = await idbGet(EXCEL_BACKUP_HANDLE_KEY);
        if (!dir) {
            excelBackupEnabled = false;
            updateExcelBackupBtnUI();
            return;
        }
        const perm = await dir.queryPermission({ mode: 'readwrite' });
        if (perm !== 'granted') {
            // don't auto-prompt; keep OFF to avoid surprise dialogs
            excelBackupEnabled = false;
            updateExcelBackupBtnUI();
            return;
        }
        excelBackupDirHandle = dir;
        excelBackupEnabled = true;
        updateExcelBackupBtnUI();
    } catch (e) {
        console.warn('[ExcelAutoBackup] load failed:', e);
        excelBackupEnabled = false;
        updateExcelBackupBtnUI();
    }
}

function scheduleExcelBackup() {
    if (!excelBackupEnabled || !excelBackupDirHandle) return;
    if (!window.XLSX) return;
    if (excelBackupTimer) clearTimeout(excelBackupTimer);
    excelBackupTimer = setTimeout(runExcelBackupNow, 800);
}

function buildExportAOAForBackup() {
    // Same export structure and sorting as manual export
    return buildSortedExportAOA();
}

async function runExcelBackupNow() {
    try {
        if (!excelBackupEnabled || !excelBackupDirHandle) return;
        if (!window.XLSX) return;

        const stamp = yymmddLocal(); // 'YYMMDD'
        const filename = `seller_backup_${stamp}.xlsx`; // ends with _YYMMDD.xlsx

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(buildExportAOAForBackup());
        XLSX.utils.book_append_sheet(wb, ws, "ë§¤ì¶œí˜„í™©");

        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

        const fileHandle = await excelBackupDirHandle.getFileHandle(filename, { create: true });
        const writable = await fileHandle.createWritable(); // overwrites silently
        await writable.write(blob);
        await writable.close();
        // no alert; silent
    } catch (e) {
        console.warn('[ExcelAutoBackup] write failed:', e);
        // If permission is lost, turn off without prompting
        if (String(e?.name || '').includes('NotAllowed') || String(e?.name || '').includes('Security')) {
            excelBackupEnabled = false;
            excelBackupDirHandle = null;
            localStorage.setItem(EXCEL_BACKUP_ENABLED_KEY, '0');
            updateExcelBackupBtnUI();
        }
    }
}

function saveToLocal() {
    localStorage.setItem('sorted_rawData', JSON.stringify(rawData));
    localStorage.setItem('sorted_salesLogs', JSON.stringify(salesLogs));
    scheduleAutoBackup();
    scheduleExcelBackup();
}
    function loadFromLocal() {
        try {
            rawData = JSON.parse(localStorage.getItem('sorted_rawData') || '[]') || [];
            salesLogs = JSON.parse(localStorage.getItem('sorted_salesLogs') || '[]') || [];
        } catch (e) {
            rawData = [];
            salesLogs = [];
        }
        rawData.forEach(s => { s.products = Array.isArray(s.products) ? s.products : []; });
        salesLogs = Array.isArray(salesLogs) ? salesLogs : [];
    }

    // -------------------------
    // Period filter helpers
    // -------------------------
    function getPeriod() {
        const year = document.getElementById('filterYear').value || '';
        const month = document.getElementById('filterMonth').value || '';
        const filterKey = (year && month) ? `${year}-${month}` : (year ? year : '');
        const label = (year && month) ? `${year}-${month}` : (year ? `${year}` : 'ì „ì²´');
        return { year, month, filterKey, label };
    }

    function filterLogsByPeriod(logs) {
        const { year, month } = getPeriod();
        if (year && month) return logs.filter(l => (l.date || '').includes(`${year}-${month}`));
        if (year) return logs.filter(l => (l.date || '').startsWith(year + '-'));
        return logs.slice();
    }

    function uniqueSorted(arr) {
        return Array.from(new Set(arr.filter(Boolean))).sort(koreanSort);
    }

    function resetGlobalFilter() {
        document.getElementById('filterYear').value = "";
        document.getElementById('filterMonth').value = "";
        renderAll();
    }

    // -------------------------
    // UI controls
    // -------------------------
    function setSellerFilter(f) {
        sellerFilter = f;
        const all = document.getElementById('filterAll');
        const has = document.getElementById('filterHas');
        const no = document.getElementById('filterNo');

        all.className = `px-3 py-2 text-[11px] font-bold rounded-lg transition-all ${f==='all' ? 'active-filter-btn text-white' : 'text-slate-500 hover:bg-white'}`;
        has.className = `px-3 py-2 text-[11px] font-bold rounded-lg transition-all ${f==='hasProduct' ? 'active-filter-btn text-white' : 'text-slate-500 hover:bg-white'}`;
        no.className  = `px-3 py-2 text-[11px] font-bold rounded-lg transition-all ${f==='noProduct' ? 'active-filter-btn text-white' : 'text-slate-500 hover:bg-white'}`;
        renderAll();
    }

    function setStatsMode(mode) {
        statsMode = mode;
        const sBtn = document.getElementById('statsModeSeller');
        const pBtn = document.getElementById('statsModeProduct');
        sBtn.className = `px-3 py-2 text-[11px] font-bold rounded-lg transition-all ${mode==='seller' ? 'active-filter-btn text-white' : 'text-slate-500 hover:bg-white'}`;
        pBtn.className = `px-3 py-2 text-[11px] font-bold rounded-lg transition-all ${mode==='product' ? 'active-filter-btn text-white' : 'text-slate-500 hover:bg-white'}`;
        renderAll();
    }

    function switchView(view) {
        currentView = view;

        document.getElementById('viewSellerBtn').classList.toggle('active-view-btn', view === 'seller');
        document.getElementById('viewProductBtn').classList.toggle('active-view-btn', view === 'product');
        document.getElementById('viewStatsBtn').classList.toggle('active-view-btn', view === 'stats');

        document.getElementById('viewSellerBtn').classList.toggle('text-slate-500', view !== 'seller');
        document.getElementById('viewProductBtn').classList.toggle('text-slate-500', view !== 'product');
        document.getElementById('viewStatsBtn').classList.toggle('text-slate-500', view !== 'stats');

        document.getElementById('mainGrid').classList.toggle('hidden', view === 'stats');
        document.getElementById('statsView').classList.toggle('hidden', view !== 'stats');

        document.getElementById('sellerFilterGroup').style.display = (view === 'seller') ? 'flex' : 'none';
        document.getElementById('searchArea').style.display = (view === 'stats') ? 'none' : 'block';

        renderAll();
    }

    function renderAll() {
        renderMain();
        renderStats();
        // modal open => refresh its contents immediately on period change
        if (!document.getElementById('modal').classList.contains('hidden')) {
            refreshSellerModalOnPeriodChange();
        }
        if (!document.getElementById('productModal').classList.contains('hidden')) {
            renderProductModal();
        }
    }

    // -------------------------
    // Main render
    // -------------------------
    function createCard(title, items, type, salesVal = 0, salesLabel = 'ì‹¤ì ') {
        const div = document.createElement('div');
        const color = type === 'SELLER' ? 'blue' : 'emerald';
        div.className = "card-animate bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-200 hover:shadow-xl hover:border-blue-300 transition-all cursor-pointer group";

        div.onclick = () => {
            if (type === 'SELLER') openSellerModal(title);
            else openProductModal(title);
        };

        const chips = items.length > 0
            ? items.map(i => `<span class="bg-slate-50 text-slate-500 px-2 py-1 rounded-lg text-[9px] font-bold border border-slate-100">${escapeHtml(i)}</span>`).join('')
            : `<span class="text-slate-300 text-[9px] italic font-medium">${type==='SELLER' ? 'ì—°ê²° ìƒí’ˆ ì—†ìŒ' : 'ì—°ê²° ì…€ëŸ¬ ì—†ìŒ'}</span>`;

        div.innerHTML = `
            <div class="mb-3 flex justify-between items-center">
                <span class="text-[9px] font-black text-${color}-500 tracking-widest uppercase">${type}</span>
                <span class="text-[10px] font-bold text-slate-300 group-hover:text-blue-500 italic uppercase">Manage</span>
            </div>
            <h3 class="text-lg font-black text-slate-800 mb-1">${escapeHtml(title)}</h3>
            <p class="text-xs font-black text-${color}-600 mb-3 bg-${color}-50 inline-block px-2 py-1 rounded-lg">
                ${escapeHtml(salesLabel)}: ${Number(salesVal || 0).toFixed(2)}ì–µ
            </p>
            <div class="flex flex-wrap gap-1">${chips}</div>
        `;
        return div;
    }

    // ë¹ˆ ìƒíƒœ ì¹´ë“œ ìƒì„±
    function createEmptyStateCard(type) {
        const div = document.createElement('div');
        div.className = "card-animate empty-state-card p-8 rounded-[2.5rem] shadow-sm transition-all cursor-pointer group flex flex-col items-center justify-center text-center min-h-[200px]";
        
        div.onclick = () => openNewEntryModal();

        const icon = type === 'seller' 
            ? `<svg class="w-12 h-12 text-slate-300 group-hover:text-blue-500 transition-colors mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
               </svg>`
            : `<svg class="w-12 h-12 text-slate-300 group-hover:text-emerald-500 transition-colors mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
               </svg>`;

        const title = type === 'seller' ? 'ì²« ë²ˆì§¸ ì…€ëŸ¬ ì¶”ê°€í•˜ê¸°' : 'ì²« ë²ˆì§¸ ìƒí’ˆ ì¶”ê°€í•˜ê¸°';
        const subtitle = type === 'seller' 
            ? 'í´ë¦­í•˜ì—¬ ìƒˆë¡œìš´ ì…€ëŸ¬ë¥¼ ë“±ë¡í•˜ì„¸ìš”' 
            : 'í´ë¦­í•˜ì—¬ ìƒˆë¡œìš´ ìƒí’ˆì„ ë“±ë¡í•˜ì„¸ìš”';

        div.innerHTML = `
            ${icon}
            <h3 class="text-lg font-black text-slate-400 group-hover:text-slate-600 transition-colors mb-2">${title}</h3>
            <p class="text-xs text-slate-400 group-hover:text-slate-500 transition-colors">${subtitle}</p>
            <div class="mt-4 px-4 py-2 bg-white rounded-xl border-2 border-dashed border-slate-300 group-hover:border-blue-400 group-hover:bg-blue-50 transition-all">
                <span class="text-xs font-bold text-slate-400 group-hover:text-blue-600">+ ì‹ ê·œ ì¶”ê°€</span>
            </div>
        `;
        return div;
    }

    function renderMain() {
        const grid = document.getElementById('mainGrid');
        if (!grid) return;
        grid.innerHTML = "";

        if (currentView === 'stats') return;

        const search = (document.getElementById('globalSearch').value || '').toLowerCase();
        const { label } = getPeriod();
        const salesLabel = (label === 'ì „ì²´') ? 'ëˆ„ì  ì‹¤ì ' : `${label} ì‹¤ì `;

        if (currentView === 'seller') {
            const sellers = (rawData || []).slice().sort((a,b)=>koreanSort(a.name,b.name));

            // ë°ì´í„°ê°€ ì—†ê³  ê²€ìƒ‰ì–´ë„ ì—†ì„ ë•Œ ë¹ˆ ìƒíƒœ ì¹´ë“œ í‘œì‹œ
            if (sellers.length === 0 && !search) {
                grid.appendChild(createEmptyStateCard('seller'));
                return;
            }

            let hasVisibleCards = false;

            sellers.forEach(s => {
                const sellerLogs = filterLogsByPeriod(salesLogs.filter(l => l.seller === s.name));
                const productsInPeriod = uniqueSorted(sellerLogs.map(l => l.product));
                const targetSales = sellerLogs.reduce((sum, l) => sum + Number(l.revenue || 0), 0);

                const hasProductInPeriod = productsInPeriod.length > 0;

                // search (seller name OR master products OR period products)
                const masterProducts = uniqueSorted((s.products || []));
                const matchesSearch =
                    (s.name || '').toLowerCase().includes(search) ||
                    masterProducts.some(p => (p || '').toLowerCase().includes(search)) ||
                    productsInPeriod.some(p => (p || '').toLowerCase().includes(search));

                let matchesFilter = true;
                if (sellerFilter === 'hasProduct') matchesFilter = hasProductInPeriod;
                if (sellerFilter === 'noProduct') matchesFilter = !hasProductInPeriod;

                if (!matchesSearch || !matchesFilter) return;

                hasVisibleCards = true;
                grid.appendChild(createCard(s.name, productsInPeriod, 'SELLER', targetSales, salesLabel));
            });

            if (!hasVisibleCards) {
                if (search) {
                    grid.innerHTML = `<div class='text-center py-12 text-slate-300 font-black uppercase col-span-full'>ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;
                } else {
                    grid.appendChild(createEmptyStateCard('seller'));
                }
            }
            return;
        }

        if (currentView === 'product') {
            // master products set (so card exists even with 0 sales), but sellers list derived from period logs to prevent phantom chips
            const master = new Set();
            rawData.forEach(s => (s.products || []).forEach(p => master.add(p)));
            salesLogs.forEach(l => { if (l.product) master.add(l.product); });

            const products = Array.from(master).filter(Boolean).sort(koreanSort);

            // ë°ì´í„°ê°€ ì—†ê³  ê²€ìƒ‰ì–´ë„ ì—†ì„ ë•Œ ë¹ˆ ìƒíƒœ ì¹´ë“œ í‘œì‹œ
            if (products.length === 0 && !search) {
                grid.appendChild(createEmptyStateCard('product'));
                return;
            }

            let hasVisibleCards = false;

            products.forEach(p => {
                const logs = filterLogsByPeriod(salesLogs.filter(l => l.product === p));
                const sales = logs.reduce((sum, l) => sum + Number(l.revenue || 0), 0);
                const sellersInPeriod = uniqueSorted(logs.map(l => l.seller));

                const matchesSearch =
                    (p || '').toLowerCase().includes(search) ||
                    sellersInPeriod.some(n => (n || '').toLowerCase().includes(search));

                if (!matchesSearch) return;

                hasVisibleCards = true;
                grid.appendChild(createCard(p, sellersInPeriod, 'PRODUCT', sales, salesLabel));
            });

            if (!hasVisibleCards) {
                if (search) {
                    grid.innerHTML = `<div class='text-center py-12 text-slate-300 font-black uppercase col-span-full'>ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;
                } else {
                    grid.appendChild(createEmptyStateCard('product'));
                }
            }
        }
    }

    // -------------------------
    // Stats render
    // -------------------------
    function renderStats() {
        if (currentView !== 'stats') return;

        const { label } = getPeriod();
        document.getElementById('statsDisplayTitle').innerText = (label === 'ì „ì²´') ? 'ì „ì²´ í†µí•© ë¶„ì„' : `${label} ìƒì„¸ ë¶„ì„`;

        const filteredLogs = filterLogsByPeriod(salesLogs);
        const totalRevenue = filteredLogs.reduce((sum, l) => sum + Number(l.revenue || 0), 0);
        document.getElementById('totalMonthRevenue').innerHTML = `${totalRevenue.toFixed(2)} <span class="text-xl font-bold">ì–µì›</span>`;

        const agg = {};
        filteredLogs.forEach(l => {
            const key = (statsMode === 'seller') ? l.seller : l.product;
            if (!key) return;
            agg[key] = (agg[key] || 0) + Number(l.revenue || 0);
        });

        const sorted = Object.entries(agg).sort((a,b)=>b[1]-a[1]);
        const container = document.getElementById('statsTableContainer');
        container.innerHTML = "";

        if (!sorted.length) {
            container.innerHTML = `
                <div class='text-center py-12'>
                    <div class="text-slate-300 font-black uppercase mb-4">No Data</div>
                    <button onclick="openNewEntryModal()" class="px-4 py-2 bg-blue-600 text-white rounded-xl text-xs font-bold hover:bg-blue-700 transition-all">
                        + ë°ì´í„° ì¶”ê°€í•˜ê¸°
                    </button>
                </div>`;
            return;
        }

        sorted.forEach(([name, rev], idx) => {
            const percent = totalRevenue > 0 ? (rev / totalRevenue * 100).toFixed(1) : '0.0';
            const row = document.createElement('div');
            row.className = "flex items-center gap-4 bg-slate-50 p-4 rounded-2xl border border-slate-100 hover:bg-white hover:shadow-md transition-all";
            row.innerHTML = `
                <div class="w-8 h-8 flex items-center justify-center bg-blue-600 rounded-full text-[10px] font-black text-white">${idx + 1}</div>
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-1">
                        <h5 class="text-sm font-black text-slate-800">${escapeHtml(name)}</h5>
                        <span class="text-xs font-bold text-blue-600">${Number(rev||0).toFixed(2)}ì–µ</span>
                    </div>
                    <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                        <div class="bg-blue-500 h-full transition-all duration-700" style="width: ${percent}%;"></div>
                    </div>
                </div>
                <div class="text-right w-12 text-[11px] font-black text-slate-400">${percent}%</div>
            `;
            container.appendChild(row);
        });
    }

    // -------------------------
    // ì‹ ê·œ ë°ì´í„° ì…ë ¥ ëª¨ë‹¬
    // -------------------------
    function openNewEntryModal() {
        // datalist ì—…ë°ì´íŠ¸
        updateNewEntryDataLists();
        
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('newSellerName').value = '';
        document.getElementById('newProductName').value = '';
        document.getElementById('newEventDate').value = '';
        document.getElementById('newRevenue').value = '';
        
        document.getElementById('newEntryModal').classList.remove('hidden');
        
        // ì…€ëŸ¬ëª… ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
        setTimeout(() => {
            document.getElementById('newSellerName').focus();
        }, 100);
    }

    function closeNewEntryModal() {
        document.getElementById('newEntryModal').classList.add('hidden');
    }

    function updateNewEntryDataLists() {
        // ê¸°ì¡´ ì…€ëŸ¬ ëª©ë¡
        const sellersList = document.getElementById('existingSellersList');
        sellersList.innerHTML = '';
        const sellers = uniqueSorted(rawData.map(s => s.name));
        sellers.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            sellersList.appendChild(opt);
        });

        // ê¸°ì¡´ ìƒí’ˆ ëª©ë¡
        const productsList = document.getElementById('existingProductsList');
        productsList.innerHTML = '';
        const products = getGlobalMasterProducts();
        products.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            productsList.appendChild(opt);
        });
    }

    function submitNewEntry() {
        const sellerName = (document.getElementById('newSellerName').value || '').trim();
        const productName = (document.getElementById('newProductName').value || '').trim();
        const eventDate = document.getElementById('newEventDate').value || '';
        const revenueVal = document.getElementById('newRevenue').value;
        const revenue = revenueVal ? Number(revenueVal) : null;

        // ì…€ëŸ¬ëª… í•„ìˆ˜ ì²´í¬
        if (!sellerName) {
            alert('ì…€ëŸ¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            document.getElementById('newSellerName').focus();
            return;
        }

        // ì…€ëŸ¬ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ë° ì¶”ê°€
        let seller = rawData.find(s => s.name === sellerName);
        if (!seller) {
            seller = { name: sellerName, products: [] };
            rawData.push(seller);
            rawData.sort((a, b) => koreanSort(a.name, b.name));
        }

        // ìƒí’ˆì´ ì…ë ¥ëœ ê²½ìš°
        if (productName) {
            // ì…€ëŸ¬ì˜ ì—°ê²° ìƒí’ˆì— ì¶”ê°€
            if (!seller.products.includes(productName)) {
                seller.products.push(productName);
                seller.products = uniqueSorted(seller.products);
            }

            // í–‰ì‚¬ì¼ ë˜ëŠ” ë§¤ì¶œì´ ìˆìœ¼ë©´ ë¡œê·¸ ì¶”ê°€
            if (eventDate || revenue !== null) {
                salesLogs.push({
                    id: Date.now(),
                    seller: sellerName,
                    product: productName,
                    date: eventDate,
                    revenue: revenue !== null ? revenue : 0
                });
                salesLogs.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            }
        }

        saveToLocal();
        closeNewEntryModal();
        renderAll();

        // ì„±ê³µ ë©”ì‹œì§€
        const msg = productName 
            ? `"${sellerName}" ì…€ëŸ¬ì™€ "${productName}" ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`
            : `"${sellerName}" ì…€ëŸ¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`;
        
        // ê°„ë‹¨í•œ í† ìŠ¤íŠ¸ ëŒ€ì‹  ì½˜ì†”ì— ë¡œê·¸
        console.log('[ì‹ ê·œ ì¶”ê°€]', msg);
    }

    // -------------------------
    // Seller modal + tabs
    // -------------------------
    function switchTab(t) {
        const isRel = t === 'rel';
        document.getElementById('tabRel').classList.toggle('active-tab', isRel);
        document.getElementById('tabLog').classList.toggle('active-tab', !isRel);
        document.getElementById('tabRel').classList.toggle('text-slate-400', !isRel);
        document.getElementById('tabLog').classList.toggle('text-slate-400', isRel);
        document.getElementById('tabContentRel').classList.toggle('hidden', !isRel);
        document.getElementById('tabContentLog').classList.toggle('hidden', isRel);
    }

    function getCurrentSeller() {
        return rawData.find(s => s.name === currentTarget) || null;
    }

    function openSellerModal(sellerName) {
        currentTarget = sellerName;
        editingLogId = null;

        document.getElementById('modalTitle').innerText = sellerName;
        document.getElementById('modal').classList.remove('hidden');

        updateLogProductDropdownMaster(); // always master list
        resetLogFields();                 // clear inputs
        renderModalItemsPeriod();
        renderLogHistoryPeriod();

        switchTab('rel');
    }

    function closeModal() {
        document.getElementById('modal').classList.add('hidden');
        currentTarget = '';
        editingLogId = null;
        resetLogFields();
    }

    function refreshSellerModalOnPeriodChange() {
        // If selected log is out of current period -> deselect and reset
        if (editingLogId) {
            const log = salesLogs.find(l => l.id === editingLogId);
            const visibleIds = new Set(filterLogsByPeriod(salesLogs.filter(l => l.seller === currentTarget)).map(l => l.id));
            if (!log || !visibleIds.has(editingLogId)) {
                editingLogId = null;
                resetLogFields();
            }
        }
        updateLogProductDropdownMaster();
        renderModalItemsPeriod();
        renderLogHistoryPeriod();
    }

    // í–‰ì‚¬ìƒí’ˆ íƒ­: í•´ë‹¹ ê¸°ê°„ ë¡œê·¸ì— ì¡´ì¬í•˜ëŠ” ìƒí’ˆë§Œ
    function renderModalItemsPeriod() {
        const listEl = document.getElementById('modalItemList');
        listEl.innerHTML = "";
        if (!currentTarget) return;

        const sellerLogs = filterLogsByPeriod(salesLogs.filter(l => l.seller === currentTarget));
        const products = uniqueSorted(sellerLogs.map(l => l.product));

        if (!products.length) {
            listEl.innerHTML = `
                <div class="text-center py-10 text-slate-300 font-black uppercase w-full">
                    ì—°ê²° ìƒí’ˆ ì—†ìŒ
                    <div class="mt-2 text-[11px] font-bold text-slate-400 normal-case">
                        ì‹ ê·œ ì…ë ¥ì€ <b>ì¼ì •/ë§¤ì¶œ ê¸°ë¡</b> íƒ­ì—ì„œ ì „ì²´ ì—°ê²° ìƒí’ˆì„ ì„ íƒí•´ ì¶”ê°€í•˜ì„¸ìš”.
                    </div>
                </div>`;
            return;
        }

        products.forEach(p => {
            const pLogs = sellerLogs.filter(l => l.product === p);
            const totalSales = pLogs.reduce((sum, l) => sum + Number(l.revenue || 0), 0);
            const dates = uniqueSorted(pLogs.map(l => l.date)).slice(0, 3).join(', ');

            const chip = document.createElement('div');
            chip.className = "bg-white text-slate-700 px-3 py-2 rounded-xl text-xs font-bold border border-slate-200 shadow-sm flex items-center gap-2 hover:bg-blue-50 transition-all cursor-pointer";

            chip.innerHTML = `
                <span>${escapeHtml(p)}</span>
                ${dates ? `<span class="text-blue-500 font-black ml-1 text-[9px] bg-blue-50 px-1.5 py-0.5 rounded-lg border border-blue-100 shadow-sm">${escapeHtml(dates)}</span>` : ''}
                <span class="text-slate-400 font-normal">(${totalSales.toFixed(2)}ì–µ)</span>
            `;

            chip.onclick = () => {
                // ìš”êµ¬ì‚¬í•­: í–‰ì‚¬ìƒí’ˆ í´ë¦­ -> ì¼ì •/ë§¤ì¶œ ê¸°ë¡ íƒ­ ì•„ë˜(ë¡œê·¸ ë¦¬ìŠ¤íŠ¸)ì—ì„œ í•´ë‹¹ ìƒí’ˆ í•­ëª© í…Œë‘ë¦¬ í† ê¸€ ON
                switchTab('log');

                // dropdownì€ í•­ìƒ ë§ˆìŠ¤í„°ì§€ë§Œ, í¸ì˜ë¥¼ ìœ„í•´ ìƒí’ˆ ì„ íƒì€ í•´ë‹¹ ìƒí’ˆìœ¼ë¡œ ë§ì¶¤
                document.getElementById('logProduct').value = p;

                // ê°€ì¥ ìµœê·¼ ë¡œê·¸(í•´ë‹¹ ê¸°ê°„) ì„ íƒ + í¼ ì±„ì›€ + íŒŒë€ í…Œë‘ë¦¬ ON
                const latest = pLogs.slice().sort((a,b) => (b.date||'').localeCompare(a.date||''))[0];
                if (latest) {
                    selectLog(latest, { fromRelClick: true });
                } else {
                    // í˜¹ì‹œë‚˜ ì—†ëŠ” ê²½ìš°: ì‹ ê·œ ì…ë ¥ ì¤€ë¹„
                    editingLogId = null;
                    resetLogFields({ keepProduct: true });
                    renderLogHistoryPeriod();
                }
            };

            listEl.appendChild(chip);
        });
    }


    function getGlobalMasterProducts() {
        const set = new Set();
        (rawData || []).forEach(s => (s.products || []).forEach(p => { if (p) set.add(p); }));
        (salesLogs || []).forEach(l => { if (l && l.product) set.add(l.product); });
        return uniqueSorted(Array.from(set));
    }

    // ì¼ì •/ë§¤ì¶œ ê¸°ë¡ íƒ­: ìƒí’ˆ dropdownì€ í•­ìƒ ë§ˆìŠ¤í„° ëª©ë¡
    function updateLogProductDropdownMaster() {
        const select = document.getElementById('logProduct');
        if (!select) return;

        const currentValue = select.value || "";
        select.innerHTML = "<option value=''>ìƒí’ˆ ì„ íƒ</option>";

        // âœ… ìš”êµ¬ì‚¬í•­: ì‹ ê·œ ì…ë ¥ì„ ìœ„í•´ í•­ìƒ 'ì „ì²´ ìƒí’ˆ(ë§ˆìŠ¤í„°)'ì„ í‘œì‹œ
        // ë§ˆìŠ¤í„°(ì „ì²´ ìƒí’ˆ) = (ëª¨ë“  ì…€ëŸ¬ì˜ ì—°ê²° ìƒí’ˆ) âˆª (ì „ì²´ ë¡œê·¸ì— ë“±ì¥í•œ ìƒí’ˆ)
        const products = getGlobalMasterProducts();
        products.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = p;
            select.appendChild(opt);
        });

        // ê°€ëŠ¥í•œ ê²½ìš° ê¸°ì¡´ ì„ íƒ ìœ ì§€
        if (currentValue && products.includes(currentValue)) select.value = currentValue;
    }


    function renderLogHistoryPeriod() {
        const container = document.getElementById('logHistoryList');
        container.innerHTML = "";
        if (!currentTarget) return;

        const logs = filterLogsByPeriod(salesLogs.filter(l => l.seller === currentTarget))
            .slice()
            .sort((a,b) => (b.date||'').localeCompare(a.date||''));

        if (!logs.length) {
            container.innerHTML = "<div class='text-center py-10 text-slate-300 font-black uppercase'>No History</div>";
            return;
        }

        logs.forEach(l => {
            const div = document.createElement('div');
            const isSelected = (l.id === editingLogId);
            div.className = `flex justify-between items-center p-3 bg-white rounded-xl border border-slate-200 shadow-sm cursor-pointer hover:border-blue-400 transition-all group ${isSelected ? 'selected-log-item' : ''}`;

            div.onclick = (e) => {
                if (e.target.closest('button')) return;
                if (editingLogId === l.id) {
                    // toggle off
                    editingLogId = null;
                    resetLogFields(); // ì™„ì „ ì´ˆê¸°í™”
                    renderLogHistoryPeriod();
                } else {
                    selectLog(l);
                }
            };

            div.innerHTML = `
                <div class="flex flex-col">
                    <span class="text-[9px] font-black text-blue-500 uppercase">${escapeHtml(l.date || 'ë‚ ì§œ ë¯¸ì •')}</span>
                    <span class="text-xs font-bold text-slate-700">
                        ${escapeHtml(l.product || '')} - <span class="text-blue-700">${Number(l.revenue || 0).toFixed(2)}ì–µ</span>
                    </span>
                </div>
                <button onclick="deleteLog(${l.id})" class="text-slate-300 hover:text-red-500 transition-all">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            container.appendChild(div);
        });
    }

    function selectLog(log, opts = {}) {
        // ì„ íƒ ON
        editingLogId = log.id;

        document.getElementById('logDate').value = log.date || "";
        document.getElementById('logProduct').value = log.product || "";
        document.getElementById('logRevenue').value = (log.revenue !== null && log.revenue !== undefined) ? Number(log.revenue).toFixed(2) : "";

        const btn = document.getElementById('submitLogBtn');
        btn.innerText = "ê¸°ë¡ ìˆ˜ì •";
        btn.className = "w-full bg-blue-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-blue-700 shadow-md";

        renderLogHistoryPeriod();
    }

    function resetLogFields(opts = {}) {
        const keepProduct = !!opts.keepProduct;
        const productVal = keepProduct ? (document.getElementById('logProduct').value || "") : "";

        document.getElementById('logDate').value = "";
        document.getElementById('logRevenue').value = "";
        document.getElementById('logProduct').value = productVal;

        const btn = document.getElementById('submitLogBtn');
        btn.innerText = "ê¸°ë¡ ì¶”ê°€/ìˆ˜ì •";
        btn.className = "w-full bg-blue-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-blue-700 shadow-sm";
    }

    function submitLog() {
        if (!currentTarget) return;

        const date = document.getElementById('logDate').value || "";
        const product = document.getElementById('logProduct').value || "";
        const revenue = Number(document.getElementById('logRevenue').value || 0);

        if (!product) return alert("ìƒí’ˆ ì„ íƒ í•„ìš”");

        // âœ… ì‹ ê·œ ì…ë ¥ ì‹œ: ì„ íƒëœ ìƒí’ˆì„ í•´ë‹¹ ì…€ëŸ¬ì˜ 'ì—°ê²° ìƒí’ˆ(ë§ˆìŠ¤í„°)'ì— ìë™ ë°˜ì˜
        const sellerObj = getCurrentSeller();
        if (sellerObj) {
            sellerObj.products = Array.isArray(sellerObj.products) ? sellerObj.products : [];
            if (product && !sellerObj.products.includes(product)) {
                sellerObj.products.push(product);
                sellerObj.products = uniqueSorted(sellerObj.products);
            }
        }


        if (editingLogId) {
            const idx = salesLogs.findIndex(l => l.id === editingLogId);
            if (idx !== -1) {
                salesLogs[idx] = { ...salesLogs[idx], date, product, revenue };
            }
            editingLogId = null;
        } else {
            salesLogs.push({ id: Date.now(), seller: currentTarget, product, date, revenue });
        }

        salesLogs.sort((a,b) => (b.date||'').localeCompare(a.date||''));
        saveToLocal();

        // ì‹ ê·œ ì…ë ¥ ì¤€ë¹„: ë‚ ì§œ/ë§¤ì¶œë§Œ ë¹„ìš°ê³  ìƒí’ˆ ì„ íƒì€ ìœ ì§€
        resetLogFields({ keepProduct: true });

        renderModalItemsPeriod();
        renderLogHistoryPeriod();
        renderMain(); // refresh cards
        if (currentView === 'stats') renderStats();
    }

    function deleteLog(id) {
        if (!confirm("ê¸°ë¡ì„ ì‚­ì œí•©ë‹ˆê¹Œ?")) return;
        salesLogs = salesLogs.filter(l => l.id !== id);
        if (editingLogId === id) {
            editingLogId = null;
            resetLogFields();
        }
        saveToLocal();
        renderModalItemsPeriod();
        renderLogHistoryPeriod();
        renderMain();
        if (currentView === 'stats') renderStats();
        if (!document.getElementById('productModal').classList.contains('hidden')) renderProductModal();
    }

    // -------------------------
    // Product modal
    // -------------------------
    function openProductModal(productName) {
        currentProductTarget = productName;
        renderProductModal();
        document.getElementById('productModal').classList.remove('hidden');
    }
    function closeProductModal() {
        document.getElementById('productModal').classList.add('hidden');
        currentProductTarget = '';
    }

    function renderProductModal() {
        const productName = currentProductTarget;
        if (!productName) return;

        const { label } = getPeriod();
        document.getElementById('productModalTitle').innerText = productName;
        document.getElementById('productModalSubtitle').innerText = (label === 'ì „ì²´') ? 'ì „ì²´ ê¸°ê°„ ê¸°ì¤€' : `${label} ê¸°ì¤€`;

        const logs = filterLogsByPeriod(salesLogs.filter(l => l.product === productName));

        const agg = {};
        logs.forEach(l => {
            if (!l.seller) return;
            agg[l.seller] = (agg[l.seller] || 0) + Number(l.revenue || 0);
        });

        const sorted = Object.entries(agg).sort((a,b)=>b[1]-a[1]);
        const total = sorted.reduce((s, [,v]) => s + Number(v||0), 0);
        document.getElementById('productSellerTotal').innerText = `í•©ê³„ ${total.toFixed(2)}ì–µ`;

        const list = document.getElementById('productSellerList');
        list.innerHTML = "";

        if (!sorted.length) {
            list.innerHTML = "<div class='text-center py-10 text-slate-300 font-black uppercase'>No Data</div>";
            return;
        }

        sorted.forEach(([seller, v]) => {
            const row = document.createElement('div');
            row.className = "flex items-center justify-between p-3 rounded-xl border border-slate-200 bg-white shadow-sm";
            row.innerHTML = `<span class="text-xs font-black text-slate-700">${escapeHtml(seller)}</span><span class="text-xs font-black text-emerald-600">${Number(v||0).toFixed(2)}ì–µ</span>`;
            list.appendChild(row);
        });
    }

    // -------------------------
    // Excel import/export (rev5 compatible)
    // -------------------------
	
function buildSortedExportAOA() {
    // Columns: ì…€ëŸ¬ëª…, ìƒí’ˆëª…, í–‰ì‚¬ì¼, ë§¤ì¶œì•¡(ì–µì›)
    // Sort priority: 1) ìƒí’ˆ ìœ ë¬´(ìƒí’ˆ ì—†ëŠ” ì…€ëŸ¬ëŠ” ë§¨ ë°‘) 2) ì…€ëŸ¬ëª…(ê°€ë‚˜ë‹¤) 3) í–‰ì‚¬ì¼(ì˜¤ë¦„ì°¨ìˆœ)
    // Tie-breakers: ìƒí’ˆëª…(ê°€ë‚˜ë‹¤) -> ë§¤ì¶œì•¡(ì˜¤ë¦„ì°¨ìˆœ)

    const header = ["ì…€ëŸ¬ëª…", "ìƒí’ˆëª…", "í–‰ì‚¬ì¼", "ë§¤ì¶œì•¡(ì–µì›)"];

    // ìƒí’ˆ ìœ ë¬´ íŒë‹¨: ê¸°ë³¸ì€ rawDataì˜ ì—°ê²°ìƒí’ˆ ê¸°ì¤€.
    // ë‹¨, rawDataì— ì—†ëŠ” ì…€ëŸ¬ê°€ ë¡œê·¸ì—ë§Œ ì¡´ì¬í•˜ëŠ” ê²½ìš°ëŠ” ë¡œê·¸ ê¸°ì¤€ìœ¼ë¡œ "ìƒí’ˆ ìˆìŒ" ì²˜ë¦¬.
    const sellerHasProduct = new Map();
    (rawData || []).forEach(s => {
        const products = Array.isArray(s.products) ? s.products : [];
        sellerHasProduct.set(s.name || "", products.length > 0);
    });
    (salesLogs || []).forEach(l => {
        const seller = l?.seller || "";
        if (!seller) return;
        if (!sellerHasProduct.has(seller)) sellerHasProduct.set(seller, !!l?.product);
    });

    // Build rows
    const rows = [];

    // 1) Logs
    (salesLogs || []).forEach(l => {
        rows.push({
            seller: l?.seller || "",
            product: l?.product || "",
            date: l?.date || "",
            revenue: (l?.revenue === null || l?.revenue === undefined) ? "" : l.revenue
        });
    });

    // 2) Connections without logs + sellers without products
    (rawData || []).forEach(s => {
        const seller = s?.name || "";
        const products = Array.isArray(s?.products) ? s.products : [];

        if (!products.length) {
            rows.push({ seller, product: "", date: "", revenue: "" });
            return;
        }
        products.forEach(p => {
            const has = (salesLogs || []).some(l => l && l.seller === seller && l.product === p);
            if (!has) rows.push({ seller, product: p || "", date: "", revenue: "" });
        });
    });

    // Sort
    rows.sort((a, b) => {
        const aHas = sellerHasProduct.get(a.seller) ? 1 : 0;
        const bHas = sellerHasProduct.get(b.seller) ? 1 : 0;
        if (aHas !== bHas) return bHas - aHas; // ìƒí’ˆ ìˆìŒ ë¨¼ì €

        const sellerCmp = (a.seller || "").localeCompare((b.seller || ""), "ko");
        if (sellerCmp !== 0) return sellerCmp;

        const aDate = (a.date || "").trim() ? String(a.date).trim().slice(0, 10) : "9999-12-31";
        const bDate = (b.date || "").trim() ? String(b.date).trim().slice(0, 10) : "9999-12-31";
        if (aDate !== bDate) return aDate.localeCompare(bDate);

        const prodCmp = (a.product || "").localeCompare((b.product || ""), "ko");
        if (prodCmp !== 0) return prodCmp;

        const ar = (a.revenue === "" ? Number.POSITIVE_INFINITY : Number(a.revenue));
        const br = (b.revenue === "" ? Number.POSITIVE_INFINITY : Number(b.revenue));
        return ar - br;
    });

    const aoa = [header, ...rows.map(r => [r.seller, r.product, r.date, r.revenue])];
    return aoa;
}

function exportToExcel() {
    const excelData = buildSortedExportAOA();
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    XLSX.utils.book_append_sheet(wb, ws, "ë§¤ì¶œí˜„í™©");
    XLSX.writeFile(wb, `Report_${new Date().toISOString().slice(0, 10)}.xlsx`);
}


    function triggerImport() { document.getElementById('importFile').click(); }

    function importData(e) {
        const file = e.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

                const sellerMap = new Map();
                const newLogs = [];

                rows.forEach((row, index) => {
                    const seller = String(row["ì…€ëŸ¬ëª…"] || row["ì…€ëŸ¬"] || row["Seller"] || row["seller"] || "").trim();
                    if (!seller) return;

                    if (!sellerMap.has(seller)) sellerMap.set(seller, { name: seller, products: [] });

                    const product = String(row["ìƒí’ˆëª…"] || row["ìƒí’ˆ"] || row["Product"] || row["product"] || "").trim();
                    if (product) {
                        const s = sellerMap.get(seller);
                        if (!s.products.includes(product)) s.products.push(product);
                    }

                    let date = row["í–‰ì‚¬ì¼"] || row["ì¼ì •"] || row["ë‚ ì§œ"] || row["Date"] || row["date"] || "";
                    if (date instanceof Date) date = date.toISOString().split('T')[0];
                    else date = String(date).trim().slice(0, 10);

                    let revenue = row["ë§¤ì¶œì•¡(ì–µì›)"] ?? row["ë§¤ì¶œì•¡"] ?? row["ë§¤ì¶œ"] ?? row["Revenue"] ?? row["revenue"] ?? "";
                    const parsed = Number(String(revenue).replace(/,/g, ""));
                    const rev = isNaN(parsed) ? null : parsed;

                    if (product && (date || rev !== null)) {
                        newLogs.push({
                            id: Date.now() + index,
                            seller,
                            product,
                            date: date || "",
                            revenue: rev !== null ? rev : 0
                        });
                    }
                });

                rawData = Array.from(sellerMap.values()).map(s => ({ name: s.name, products: uniqueSorted(s.products) })).sort((a,b)=>koreanSort(a.name,b.name));
                salesLogs = newLogs.slice().sort((a,b) => (b.date||'').localeCompare(a.date||''));

                saveToLocal();
                alert(`ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!\në“±ë¡ëœ ì…€ëŸ¬: ${rawData.length}ëª…\nê¸°ë¡: ${salesLogs.length}ê±´`);
                location.reload();
            } catch (err) {
                console.error(err);
                alert("íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function clearAllData() {
        if (!confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        localStorage.removeItem('sorted_rawData');
        localStorage.removeItem('sorted_salesLogs');
        location.reload();
    }

    // -------------------------
    // Misc
    // -------------------------
    function escapeHtml(s) {
        return String(s ?? '')
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');
    }

    // -------------------------
    // Event wiring
    // -------------------------
    window.onload = () => {
        loadFromLocal();

        // restore Excel auto-backup setting (if previously granted)
        loadExcelAutoBackupSetting();
        updateExcelBackupBtnUI();

        // default view
        renderAll();

        // period change => refresh everything immediately
        document.getElementById('filterYear').addEventListener('change', renderAll);
        document.getElementById('filterMonth').addEventListener('change', renderAll);
    };

    window.onclick = (e) => {
        const modal = document.getElementById('modal');
        const pmodal = document.getElementById('productModal');
        const newEntryModal = document.getElementById('newEntryModal');
        if (e.target === modal) closeModal();
        if (e.target === pmodal) closeProductModal();
        if (e.target === newEntryModal) closeNewEntryModal();
    };
</script>

</body>
</html>
